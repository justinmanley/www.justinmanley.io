
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>

		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Blog &middot; justinmanley.io</title>

		<link rel="icon" type="image/png" href="assets/images/favicon.ico"/>

		<!-- GitHub icons and styles -->
		<link rel="stylesheet" href="assets/bower_components/octicons/octicons/octicons.css"/>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="assets/css/bootstrap.css"/>
		<link rel="stylesheet" href="assets/bower_components/bootstrap/dist/css/bootstrap-theme.css"/>
		<script src="assets/bower_components/jquery/dist/jquery.min.js"></script>
		<script src="assets/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

		<!-- FontAwesome -->	
		<link rel="stylesheet" href="assets/bower_components/font-awesome/css/font-awesome.min.css"/>
		
		<!-- LiveReload (development) -->
		<script src="http://localhost:35729/livereload.js"></script>

		<!-- Twitter javascript -->
		<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

		<!-- Site styles -->
		<link rel="stylesheet" href="assets/css/style.css"/>

		<!-- Syntax highlighting for code snippets -->
		<link rel="stylesheet" href="assets/bower_components/highlightjs/styles/paraiso.light.css">
		<script src="assets/bower_components/highlightjs/highlight.pack.js"></script>
		<script>
			hljs.initHighlightingOnLoad();
			$(document).ready(function() {
				var font_size = $('pre code').css('font-size');

				$('p > code').each(function(i, block) {
					hljs.highlightBlock(block);

					// tweak styles to match code blocks
					block.style.display = 'inline';
					block.style.fontSize = font_size;
					block.style.backgroundColor = 'rgba(0,0,0,0)';
				});
			});
		</script>

        <!-- Structured data representation for Google and other search engines. -->
        <script type="application/ld+json">
            {
                "@context": "http://schema.org",
                "@type": "Person",
                "name": "Justin Manley",
                "url": "http://justinmanley.io",
                "jobTitle": "Software Engineer",
                "worksFor": "Google",
                "gender": "Male",
                "sameAs": [
                    "https://www.linkedin.com/in/justinmanley/",
                    "https://github.com/justinmanley",
                    "https://twitter.com/outoftheyards"
                ],
                "description": "Software engineer and urbanist",
                "email": "manleyjster@gmail.com"
            }
        </script>
	</head>
	<body>
		<div class="header">
			<h2 class="brand"><a href="/">Justin Manley</a></h2>
			<p>Software engineer and urbanist.</p>	
		</div>
		<div class="navbar" role="navigation">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-links">
						<span class="sr-only">Toggle Navigation</span>
						<span class="glyphicon glyphicon-justify"></span>
					</button>
				</div>
				<div class="collapse navbar-collapse" id="nav-links">
					<ul class="nav navbar-nav">
					
						<li><a href="https://github.com/justinmanley">
							GitHub
							
								<span class="nav-external-link glyphicon glyphicon-new-window"></span>
							
						</a></li>
					
						<li><a href="/blog.html">
							Blog
							
						</a></li>
					
						<li><a href="http://www.outoftheyards.com">
							Out of the Yards
							
								<span class="nav-external-link glyphicon glyphicon-new-window"></span>
							
						</a></li>
					
						<li><a href="http://justinmanley.portfoliobox.me/">
							Portfolio
							
								<span class="nav-external-link glyphicon glyphicon-new-window"></span>
							
						</a></li>
					
						<li><a href="/work">
							Work
							
						</a></li>
					
						<li><a href="/archive">
							Archive
							
						</a></li>
					
					</ul>
				</div>
			</div>
		</div>
		



<div class="blogs-posts content">

	
		<div class="blog-post">
			<div class="blog-header">
				
				<h2 class="blog-title">Approximating Eigenvectors in Idris</h2>
				<time class="blog-published">
					Sunday October 11th, 2015
				</time>
			</div>
			<p><a href="http://www.idris-lang.org/">Idris</a> is a functional programming language with <a href="http://en.wikipedia.org/wiki/Dependent_type">dependent types</a>. In a dependently typed language, types may depend on values, as well as other types. One advantage of this is that it makes the type system much more expressive and enables the compiler to formally verify more of the logic of the program. While extremely powerful, dependent type theory is less well-understood than other formal systems (see where dependent types fit into the <a href="https://en.wikipedia.org/wiki/Lambda_cube">lambda cube</a>). Idris is exciting because it is a testing ground for research in dependent types.</p>
<p>This <a href="https://en.wikipedia.org/wiki/Literate_programming">literate program</a> explores Idris with an implementation of the <a href="https://en.wikipedia.org/wiki/Power_iteration">power method</a> for approximating the eigenvectors of a matrix.</p>
<h3 id="vectors-and-matrices">Vectors and Matrices</h3>
<p>A vector space forms an ideal setting for this exploration of Idris since many many matrix and vector operations have constraints which can be more easily represented and checked in Idris than in other languages. For example: vectors may only be multiplied if they have the same length, and two matrices must have a common dimension in order to be multiplied together.</p>
<p>Vectors in Idris have type <code>Vect n a</code>, where <code>n</code> is a natural number. That is, the type of a vector contains a <em>value</em>. This means that the vectors <code>[1,0]</code> and the vectors <code>[0,1,0]</code> actually have different types in Idris, and their multiplication via the dot product can be excluded at compile-time, rather than handled at runtime with an error or by silently discarding elements of the longer vector.</p>
<p>With a representation of vectors, it&#39;s easy to define a type for matrices:</p>
<pre><code class="language-idris">Matrix : Nat -&gt; Nat -&gt; Type -&gt; Type
Matrix m n a = Vect m (Vect n a)</code></pre>
<p>Matrix operations can be checked in the same way as vector operations.</p>
<p>All of these helper functions, which we&#39;ll use in the implementation of the power method, benefit from the compile-time checking of vector and matrix operations: </p>
<pre><code class="language-idris">norm : Vect n Double -&gt; Double
norm v = sqrt (v &lt;:&gt; v)

||| Scale v to have unit length.
normalize : Vect n Double -&gt; Vect n Double
normalize v = (1 / norm v) &lt;#&gt; v

||| Orthogonalize v to w.
orthogonalize : Vect n Double -&gt; Vect n Double -&gt; Vect n Double
orthogonalize w v = v &lt;-&gt; ((v &lt;:&gt; w) &lt;#&gt; w)</code></pre>
<p>So far, so good. The looks (pretty much) like the analogous Haskell code. The infix operators <a href="dotProduct"><code>&lt;:&gt;</code></a>, <a href="scalarProduct"><code>&lt;#&gt;</code></a>, <a href="vectorAddition"><code>&lt;+&gt;</code></a>, <a href="vectorSubtraction"><code>&lt;-&gt;</code></a>, and <a href="matrixRowVectorProduct"><code>&lt;/&gt;</code></a> (below) come from the definitions of various algebraic structures - group, ring, vector space. </p>
<h3 id="the-power-method">The Power Method</h3>
<p>With these utility functions out of the way, we&#39;re ready to implement the power method. The heavy lifting is done by a function which takes a matrix, a &quot;seed&quot; eigenvector, and a list of previously computed eigenvectors and approximates the next eigenvector to the desired precision:</p>
<pre><code class="language-idris">||| Estimate a single eigenvector to the expected precision, given
||| a list of previously calculated eigenvectors.
eigenvector : Matrix n n Double
    -&gt; Double
    -&gt; Vect n Double
    -&gt; List (Vect n Double)
    -&gt; Vect n Double</code></pre>
<p>The power method is iterative. Each iteration, we start with a &quot;seed&quot; eigenvector, our best approximation of the eigenvector we&#39;re interested in. Then, we generate a new approximation by multiplying our matrix by the &quot;seed&quot; vector and normalizing the product, which is a vector of the same length.</p>
<p>We define the error of each iteration to be the distance between our original approximation (the &quot;seed&quot;) and the new approximation. If the error is less than our desired precision, we stop; otherwise, we repeat the process with our new &quot;seed&quot;.</p>
<p>The result of this process will converge (under a few <a href="TOOD: link">conditions</a>) to the &quot;first&quot; eigenvector - an eigenvector corresponding to the eigenvalue of greatest magnitude. In order to approximate successive eigenvectors, we first orthogonalize the &quot;seed&quot; to each of the previously computed eigenvectors in turn.</p>
<pre><code class="language-idris">eigenvector {n} matrix precision seed previousEigenvectors = 
    if err &lt; precision
    then result
    else eigenvector matrix precision result previousEigenvectors where
        -- Orthogonalize the vector to each previously computed eigenvector.
        tmp : Vect n Double
        tmp = foldr orthogonalize seed previousEigenvectors

        -- &lt;/&gt; is matrix multiplication by a row vector.
        result : Vect n Double
        result = normalize $ matrix &lt;/&gt; tmp

        err : Double
        err = case compare (eigenvalue matrix result) 0 of
            GT =&gt; norm (tmp &lt;-&gt; result)
            EQ =&gt; error &quot;Error margin is undefined when the eigenvalue is 0.&quot;
            LT =&gt; norm (tmp &lt;+&gt; result)</code></pre>
<p>Note that we want the <code>tmp</code> and <code>result</code> vectors to be the same size as the &quot;seed&quot; vector, but the size of the seed vector is only carried in its type, which means that it&#39;s not automatically brought into the scope of the function body.  This is a problem unique to a dependent type system, and Idris solves it with a notion of <a href="http://idris.readthedocs.org/en/latest/tutorial/typesfuns.html?highlight=implicit#implicit-arguments">implicit arguments</a>. The size of the seed vector is explicitly brought into scope using curly braces (<code>{n}</code>), which allows <code>n</code> to be used in the type signatures of <code>result</code> and <code>tmp</code>.</p>
<h3 id="effects-and-randomness">Effects and Randomness</h3>
<p>There&#39;s a catch in what I&#39;ve described so far - the power method needs an initial seed vector to jumpstart the iterative process of approximation. The choice of seed vector is important: if the seed vector is orthogonal to the eigenvector we&#39;re trying to compute, then the iterative process will not converge. In practice, this is addressed by initializing the power method with a random seed vector, so that the probability of non-convergence is infinitesimal. </p>
<p>Constructing random vectors requires a source of random numbers from the operating system and introduces side-effects into our previously-<a href="https://en.wikipedia.org/wiki/Pure_function">pure</a> program. Handling side-effects has traditionally been a challenge for functional languages which aspire to purity. The Idris <a href="https://eb.host.cs.st-andrews.ac.uk/drafts/effects.pdf">effects</a> package offers a unique approach to handling effectful computations which is made possible by Idris&#39; dependent type system.</p>
<p>Simple effects in Idris are parameterized by the return value of the effectful computation and the particular side-effects used in the computation. Specifically, a <em>list</em> of side-effects (i.e. a value) is included in the effect type. This guarantees a high degree of type-safety for effectful computations, since the compiler can ensure that only side-effects present in the type of the computation are used. At the same time, it&#39;s easy for users to combine side-effects, without worrying about the order in which those effects are applied  (goodbye and good riddance, <a href="http://book.realworldhaskell.org/read/monad-transformers.html">monad transformers</a>!). In practice, the compiler seems to have trouble correctly resolving effect types, but hey - <a href="https://edwinb.wordpress.com/">Edwin Brady</a> <a href="https://github.com/idris-lang/Idris-dev/issues">told you</a> this is an experimental language!</p>
<p>The full Effects machinary is much more complicated and flexible than the simplified picture I&#39;ve given here; there&#39;s an excellent <a href="http://docs.idris-lang.org/en/latest/effects/index.html">tutorial on effects in Idris</a> that explains effects in greater detail.</p>
<p>Our <code>eigenvectors</code> function uses two side-effects: <code>RND</code>, to generate random numbers, and <code>SYSTEM</code>, to seed the random number generator with the system time. Both side-effects are reflected in the return type of the function. (The <code>!</code> in front of <code>time</code> unwraps the effectful value of <code>time</code> so that it can be used by <code>srand</code>). Notice again that the size of the matrix is captured via an implicit argument to <code>eigenvectors</code>.</p>
<pre><code class="language-idris">||| Calculate the eigenvectors of a matrix using the power method.
eigenvectors : Matrix n n Double 
  -&gt; Double 
  -&gt; Eff (List (Vect n Double)) [RND, SYSTEM]
eigenvectors {n} matrix precision = do
   srand !time

   -- The functions given as arguments to higher-order effectful functions
   -- (mapE, mapVE) must be syntactically applied directly to their arguments.
   seedVectors &lt;- mapE (\vs =&gt; mapVE (\x =&gt; rndDouble x) vs)
     $ List.replicate n (Vect.replicate n (cast $ 1 / precision))

   return $ mapRemember (eigenvector matrix precision) seedVectors []</code></pre>
<p>And that&#39;s it! Pick your favorite matrix and give this program a try! The full code from this blog post is available <a href="https://gist.github.com/justinmanley/f2e169feb32e06e06c2f">on GitHub</a>. And if you think Idris is cool, there&#39;s an <a href="https://groups.google.com/forum/#!forum/idris-lang">active mailing list</a> and <a href="http://docs.idris-lang.org/en/latest/tutorial/index.html">a bunch of great tutorials</a> on the Idris website.</p>

		</div>
	


	
		<div class="blog-post">
			<div class="blog-header">
				
				<h2 class="blog-title">Thoughts on the Elm language</h2>
				<time class="blog-published">
					Thursday September 10th, 2015
				</time>
			</div>
			<p><a href="http://elm-lang.org/">Elm</a> is a <a href="https://en.wikipedia.org/wiki/Type_inference">type-inferred</a> <a href="https://en.wikipedia.org/wiki/Functional_programming">functional</a> reactive language for web programming (&quot;reactive&quot; means that the language has built-in primitives for expressing time-varying values - see <a href="https://en.wikipedia.org/wiki/Functional_reactive_programming">FRP</a>).  I decided to try Elm out on a small project, a web app for displaying incoming data streams from an array of environmental sensors.</p>
<p>I built <a href="http://justinmanley.github.io/waggle-data-display/">a data display</a> (<a href="https://github.com/justinmanley/waggle-data-display">code here</a>) which reads measurements from a simple text file accessible via HTTP and produces a simple visualization. In order to show the incoming data in real time, the app must periodically check the HTTP endpoint to gather data and update the displays. These modest requirements turn out to make a great project for testing the maturity and capabilities of Elm, since they introduce a time-varying parameter at the heart of the project, and provide an opportunity to explore Elm&#39;s approach to handling <a href="https://en.wikipedia.org/wiki/Pure_function#Impure_functions">impure functions</a> like HTTP requests.</p>
<h3 id="writing-a-simple-web-app-in-elm">Writing a simple web app in Elm</h3>
<p>There can be a steep initial learning curve to getting started with Elm. Even a job as simple as sending a periodic HTTP request in Elm introduces a lot of heavy machinery: <a href="http://elm-lang.org/guide/reactivity">signals, tasks, mailboxes</a>, and <a href="http://elm-lang.org/guide/interop">ports</a>. Here&#39;s a snippet of code that&#39;s responsible for periodically retrieving data for the data display:</p>
<p>First, we declare a mailbox, a destination for unparsed data retrieved via HTTP request.</p>
<pre><code class="language-elm">rawData : Mailbox String
rawData = Signal.mailbox &quot;sensor-data&quot;</code></pre>
<p>The data we&#39;re going to retrieve will end up as a <a href="http://elm-lang.org/guide/reactivity#signals">signal</a> (time-varying value) associated with the mailbox we just created: <code>rawData.signal : Signal String</code>. To turn the raw HTTP response into something we can work with, we parse the response string, timestamp it, and then update the state (<code>SensorBoard</code>) with the latest batch of data.</p>
<pre><code class="language-elm">sensorData : Signal (Time, SensorBoard)
sensorData = Signal.map parse rawData.signal
    |&gt; Time.timestamp 
    |&gt; update</code></pre>
<p>So far, so good. The tricky part is getting the data to end up in <code>rawData.signal</code>. The function <code>getSensorData : Task Http.Error ()</code> is responsible for a single HTTP request. The type signature tells us that <code>getSensorData</code> either returns <code>()</code> (the <a href="https://en.wikipedia.org/wiki/Unit_type">unit value</a>, indicating success), or an error of type <code>Http.Error</code>. If <code>getSensorData</code> is successful, then it also updates <code>rawData.signal</code> with a new value as a <a href="https://en.wikipedia.org/wiki/Side_effect_(computer_science">side effect</a>). In order to send multiple HTTP requests to periodically retrieve data, we map <code>getSensorData</code> over a signal which updates itself every <code>Config.updateInterval</code> seconds, but always has the same value (<code>Config.sensorDataUrl</code>). </p>
<p>Finally, running this impure function requires that we declare it as a <code>port</code> at the top level.</p>
<pre><code class="language-elm">port getData : Signal (Task Http.Error ())
port getData = 
    let ticks : Signal Time
        ticks = Time.every Config.updateInterval

        getSensorData : String -&gt; Task Http.Error ()
        getSensorData url = 
            Http.getString url `andThen` Signal.send rawData.address

    -- Lifting the URL string to a constant signal which updates periodically
    -- allows us to perform the HTTP request task periodically as well. 
    in Signal.map getSensorData
        &lt;| Signal.sampleOn ticks 
        &lt;| Signal.constant Config.sensorDataUrl</code></pre>
<p>It&#39;s easy to write a solution to this problem which typechecks and looks plausible, but which only launches a single HTTP request. Getting the solution to work as intended requires thinking about the <a href="https://en.wikipedia.org/wiki/Signal-flow_graph">signal graph</a> and understanding how tasks work. It&#39;s not intuitive (at least for me). It takes a bit of thought to realize that the URL needs to masquerade as a time-varying value in order to launch periodic HTTP requests.</p>
<h3 id="successes-and-challenges">Successes and challenges</h3>
<p>As I became comfortable with Elm&#39;s FRP model, the biggest challenges I faced were the result of the relative youth of the language community.</p>
<p>There&#39;s a dearth of community libraries, and those which have been released are often in flux as their authors figure out how to express in Elm solutions originally developed in JavaScript or Haskell. The lack of stock solutions to common problems means that simple projects can take much longer than expected because so much must be built from scratch. Even the core libraries sometimes change dramatically (tasks and mailboxes were just introduced with v0.15) - and this means more time updating and refactoring code.</p>
<p>Layout and styling in particular were frustrating at times. There are two main display systems in Elm. The <a href="http://package.elm-lang.org/packages/elm-lang/core/2.1.0/Graphics-Element"><code>Graphics.*</code> core libraries</a> provide a simple layout system built of rectangular components of known width and height. This means that it&#39;s not possible to style <code>Graphics.*</code> elements with CSS. It <em>is</em> possible to use CSS with <a href="http://package.elm-lang.org/packages/evancz/elm-html/4.0.1"><code>elm-html</code></a>, but you give up the ability to get the dimensions of elements from Elm code. Fortunately, there&#39;s some good work being done on these issues right now, with <a href="http://package.elm-lang.org/packages/adam-r-kowalski/Elm-Css/2.0.0">Elm-Css</a> recently released and discussions about <a href="https://groups.google.com/forum/#!searchin/elm-discuss/gss/elm-discuss/PtHVHY9Iu1g/sqe4LSBHBwAJ">alternative layout / styling systems</a>.</p>
<p>It helps that the Elm community is friendly and supportive. When I&#39;ve been truly stumped, I&#39;ve gotten quick (and thoughtful) responses from Elm veterans on the <a href="https://groups.google.com/forum/#!forum/elm-discuss">elm-discuss</a> mailing list. The elm-discuss list is an exciting place to be; there are questions every day from beginners trying out Elm for the first time and discussions (sometimes heated) about language features and infrastructure. Even better, many of the folks involved in those conversations go on to contribute to Elm&#39;s community libraries. Since I started working on this project, in March of 2015, the number of <a href="http://package.elm-lang.org/packages">community libraries</a> has grown tenfold.</p>
<p>It also helps that Elm ships with a suite of amazing tools - the <a href="https://github.com/elm-lang/elm-platform">&quot;Elm Platform&quot;</a>, including the compiler, <a href="https://github.com/elm-lang/elm-repl">REPL</a>, <a href="https://github.com/elm-lang/elm-package">package manager</a>, and the <a href="https://github.com/elm-lang/elm-reactor">reactor</a>, an interactive development tool. These tools make it a pleasure to work in Elm.</p>
<p>But my favorite part about writing Elm, by far, is how maintainable it is. It&#39;s amazing to me how easy it was to come back to this project after 2 months away and begin to refactor messy code and add features once again. I love that I can be productive almost immediately when I sit down to revive a long-dormant Elm project. I may forget how the different pieces of my project fit together, but the Elm compiler doesn&#39;t forget. This is significant because it adds up to a big boost in productivity for web developers using Elm.</p>
<h3 id="final-thoughts">Final thoughts</h3>
<p>Elm is a work in progress. It&#39;s frustrating sometimes, because APIs change frequently and there are missing pieces, but also tremendously exciting because the performance, power, and expressiveness of the language are constantly improving.</p>
<p>The Elm community follows a top-down BDFL model, with creator Evan Czaplicki putting in the most hours and reserving the final say on questions of language syntax, features, and implementation. Czaplicki is autocratic and sometimes brusque, but he is also responsive and supportive of active contributors to the language. The scope of Czaplicki&#39;s vision has attracted an active community of language maintainers, library developers, and compiler enthusiasts to contribute to the language.</p>
<p>This community is swiftly increasing the number of available Elm libraries. Even more exciting, there are a ton of exciting improvements and features coming (hopefully) with the next compiler release, including tail call optimization, exhaustiveness checking for pattern matches, and dead-code elimination. For me, at least, Elm is not yet an efficient and effective replacement for JavaScript - but of all the frameworks and compile-to-JavaScript languages I&#39;ve worked with, Elm has the greatest potential.</p>

		</div>
	


	
		<div class="blog-post">
			<div class="blog-header">
				
					<img class="blog-header-image" src="assets/images/leaflet-toolbar-header.png"></img>
				
				<h2 class="blog-title">Designing Leaflet.toolbar</h2>
				<time class="blog-published">
					Tuesday January 6th, 2015
				</time>
			</div>
			<p><a href="https://github.com/Leaflet/Leaflet.toolbar">Leaflet.toolbar</a>, a JavaScript library for building flexible and extensible toolbars for Leaflet maps, is just released and available on <a href="https://www.npmjs.com/package/leaflet-toolbar"><code>npm</code></a>. Leaflet.toolbar is an effort to extend the excellent Leaflet.draw plugin and to enable new kinds of map / user interactions.  In particular, Leaflet.toolbar aims to:</p>
<ul>
<li>Decouple the actions exposed by a toolbar from its overall behavior and appearance;</li>
<li>Enable <em>both</em> control-style and popup-style toolbars out of the box;</li>
<li>Make it easy for library developers to define new kinds of toolbars;</li>
<li>Be easy for application developers to instantiate;</li>
<li>Remain interoperable with Leaflet.draw.</li>
</ul>
<p>Here&#39;s where Leaflet.toolbar came from and why I built it.</p>
<h3 id="why-build-a-toolbar-plugin-">Why build a toolbar plugin?</h3>
<p>The idea for Leaflet.toolbar came from a discussion with <a href="http://publiclab.org/profile/mathew">Mathew Lippincott</a> and <a href="http://publiclab.org/profile/warren">Jeffrey Warren</a> at the end of the summer of 2014.</p>
<p>Matt and Jeff were my mentors for a <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">Google Summer of Code project</a> focused on improving MapKnitter, a piece of software created by Public Lab for Open Technology and Science to enable grassroots mappers to do <a href="http://publiclab.org/wiki/mapping-curriculum-map-preparation#3.3+-+MapKnitter:+Map+stitching">georectification</a>.</p>
<p>Matt and Jeff had found that Public Lab community members, unable to communicate the purpose of their maps using MapKnitter, would export their maps as images, then draw on them in Powerpoint or by hand, adding arrows, lines, circles, and text annotations directly on the map. Matt noted in a <a href="http://publiclab.org/notes/mathew/03-14-2014/mapknitter-annotations-gsoc">wonderful research note</a> that, historically, mapmakers have written and annotated their maps using different size fonts, multiple colors, and fonts of varying sizes to encode dense, overlapping geographic information. Until recently, web maps (and especially raster maps) lacked this degree of expressiveness.</p>
<p><a href="http://i.publiclab.org/system/images/photos/000/003/256/original/bayou_manchac_sewer_outful.jpg"><img src="http://i.publiclab.org/system/images/photos/000/003/256/original/bayou_manchac_sewer_outful.jpg" alt="Mapmakers were exporting their maps as images and drawing on them in Powerpoint to communicate their purpose."></a></p>
<p>It was important to us to bring the full expressiveness of analog mapping into the browser so that citizen scientists and mapmakers could easily communicate the purpose of their maps.</p>
<p>Migrating from OpenLayers to Leaflet gave Public Lab the opportunity to envision how we might enable this kind of expressive digital mapmaking. Leaflet ships with a full complement of vector annotation layers - circles, rectangles, polygons, and polylines - that can be overlaid on maps. Leaflet.draw makes these layers interactive, enabling users to create annotations dynamically by drawing them on the map. This was a great first step. However, Leaflet.draw didn&#39;t provide any way for users to alter the style of these map annotations - their color, weight, or opacity, for example.</p>
<p>Leaflet.draw exported a toolbar which was the entry point for its interaction functionality. In <a href="https://github.com/justinmanley/Leaflet.Illustrate">Leaflet.Illustrate</a>, I began developing new kinds of map annotations. Yet, when I tried to expose these new kinds of annotations to users alongside those provided by Leaflet.draw, I found that its toolbar wasn&#39;t easy to extend. The toolbar was not the core of the new features I was trying to develop, but because it was the entry point for users, it deeply affected the user experience.</p>
<p>This plugin is an effort to generalize the elegant toolbar provided by Leaflet.draw and to overcome some of its limitations.</p>
<h3 id="toolbar-actions">Toolbar actions</h3>
<p>The toughest and most protracted challenge in designing Leaflet.toolbar was deciding how to represent toolbar actions. The difficult was that toolbar actions couldn&#39;t be instantiated when the toolbar was defined (for example, by a plugin developer) because these actions took as mandatory arguments to their constructors a <code>map</code> object, which is usually created by application developers.</p>
<p>Leaflet.draw solved this by defining the actions in the toolbar in a method of the concrete <code>DrawToolbar</code> class.</p>
<pre><code class="language-javascript">L.DrawToolbar = L.Toolbar.extend({
    ...
    getModeHandlers: <span class="function"><span class="keyword">function</span><span class="params">(map)</span> {</span>
        <span class="keyword">return</span> [
            ...
            {
                enabled: <span class="keyword">this</span>.options.polyline,
                handler: <span class="keyword">new</span> L.Draw.Polyline(map, <span class="keyword">this</span>.options.polyline),
                title: L.drawLocal.draw.toolbar.buttons.polyline
            },
            ...
        ];
    }
    ...
});</code></pre>
<p>I struggled with this for a long time. I wanted to separate the specification of a toolbar&#39;s actions from its behavior as an generic interface, so I didn&#39;t feel that it was appropriate to define the actions in a method of a specific toolbar class. Yet I was facing the same difficulty as Leaflet.draw - the necessity to make the <code>map</code> variable available to the toolbar action constructors.</p>
<p>I&#39;m very pleased with the solution I came up with (at long last, after months of re-re-refactoring). Leaflet.toolbar requires developers to define the actions in a toolbar as a simple array of constructors extending L.ToolbarAction:</p>
<pre><code class="language-javascript">L.DrawToolbar = L.Toolbar.Control.extend({
    options: {
        actions: [
            L.Draw.Polyline,
            L.Draw.Polygon,
            L.Draw.Rectangle,
            L.Draw.Circle,
            L.Draw.Marker
        ]
    }
});</code></pre>
<p>This is direct and concise. What&#39;s more, this new pattern makes it easy for application developers to customize the behavior of an action <em>at toolbar instantiation</em> by extending the action to create an anonymous class:</p>
<pre><code class="language-javascript"><span class="keyword">var</span> polylineOptions = { color: <span class="string">'#db1d0f'</span>, weight: <span class="number">3</span> };

<span class="keyword">new</span> L.DrawToolbar({
    actions: [
        L.Draw.Polyline.extend({ options: polylineOptions }),
        ...
    ]
})</code></pre>
<p>This succint specification for toolbar actions is made possible by a little bit of wizardry with Leaflet&#39;s built-in classical inheritance system and by overloading <code>L.Toolbar#addTo</code>.</p>
<h3 id="overloaded-addto-method-and-_getactionconstructor">Overloaded #addTo method and _getActionConstructor</h3>
<p>Conceptually, a toolbar is an interface that allows a user to manipulate the state of objects on the map or the map itself. Leaflet.toolbar allows the developer to specify which map objects the toolbar will control. In order to keep the API simple, <code>L.Toolbar#addTo</code> is overloaded to add the toolbar to the map, <em>and</em> to designate the map objects which the toolbar will control. The arguments of <code>L.Toolbar#addTo</code> are passed to each action in turn.  That is, </p>
<pre><code class="language-javascript"><span class="keyword">new</span> L.Popup.Toolbar({
    options: { actions: [EditShape, DeleteShape] }
}).addTo(map, shape);</code></pre>
<p>calls <code>new EditShape(map, shape)</code> and <code>new DeleteShape(map, shape)</code> in turn.</p>
<p>The magic that makes this work (which didn&#39;t come to me until late December) is all contained in <code>L.Toolbar#_getActionConstructor</code>. </p>
<p>Variadic functions are easy to construct in JavaScript using <code>Function.prototype.apply</code>, but this technique doesn&#39;t work with constructors.  To treat the toolbar action constructors generically, without regard for their arity, <code>Toolbar#_getActionConstructor</code> creates an anonymous class extending each toolbar action to initialize the toolbar action with the appropriate arguments: </p>
<pre><code class="language-javascript">_getActionConstructor: <span class="function"><span class="keyword">function</span><span class="params">(Action)</span> {</span>
    ...
    <span class="keyword">return</span> Action.extend({  <span class="comment">// creates an new class</span>
        initialize: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            Action.prototype.initialize.apply(<span class="keyword">this</span>, args);
        },
        ...
    });    
}</code></pre>
<p>This trick uses Leaflet&#39;s built-in classical inheritance system to create pseudo variadic constructors in JavaScript.</p>
<h3 id="secondary-toolbars">Secondary toolbars</h3>
<p>I thought I was done developing Leaflet.toolbar after about a month of tinkering with it in my spare time. Looking back at Leaflet.draw to confirm I had implemented all of its features, I noticed that each action in the toolbar, once triggered, provided a menu of secondary options related to the action at hand; for example, users drawing a polygon or polyline are given the option to cancel drawing, or to delete just the last point. No problem, I thought. I&#39;ll just add that in - it&#39;ll take a couple of days.</p>
<p><img src="assets/images/toolbar-actions.png" alt="Primary and secondary toolbar actions"></p>
<p>Wrong! My design at the time had no way of accomodating these secondary actions. It took me the next few months, still working in my spare time, to reorganize the code to accomodate these secondary actions.</p>
<p>The menu of secondary actions, I realized, was kind of like a toolbar.  Why not just make it an instance of <code>L.Toolbar</code>? This was the solution I settled on: the <code>subToolbar</code> option of each toolbar action points to an instance of <code>L.Toolbar</code> containing the appropriate secondary actions.</p>
<p>This system of nested toolbars made for efficient code reuse, but meant that the CSS styles had to be seriously modified. Toolbars in <code>Leaflet.toolbar</code> are automatically given a <code>leaflet-toolbar-n</code> class, where <code>n</code> is the 0-based level of the toolbar in the nested toolbar hierarchy. This allows for styles to be applied easily across all toolbars and menus at the same hierarchical level. One drawback of this method is that styles have to be tightly scoped to avoid inadvertently styling containing toolbars (for example: <code>leaflet-toolbar-0 &gt; li &gt; .leaflet-toolbar-icon {...}</code>) - but hey, you can&#39;t win them all!</p>
<h3 id="looking-back">Looking back</h3>
<p>The toughest part of this project, hands down, was dealing with the constraints of an existing API.  Developing Leaflet.toolbar was different from working on other libraries that I&#39;ve contributed to because, with Leaflet.toolbar, I was proposing to take over functionality from Leaflet.draw, rather than extending it. I wanted to inroduce a new dependency into the stack that would handle <em>existing</em> functionality. Working on a project with this degree of interdependence between the parts was new for me, and it was difficult. There were times when I felt that my ideas for Leaflet.toolbar couldn&#39;t possibly be accomodated by Leaflet.draw&#39;s API, and I dreamed about drastic rewrites of Leaflet.draw that might mesh more neatly with my toolbars. Thank god I didn&#39;t follow through on those dreams! Both Leaflet.draw and Leaflet.toolbar would have been worse off! I did make some small changes to Leaflet.draw, such as modifying each drawing handler to inherit from <code>L.ToolbarAction</code> rather than <code>L.Handler</code>, but for the most part, I left it as-is.</p>
<p>While it was sometimes frustrating, Leaflet.draw was an enormous help to me in developing Leaflet.toolbar. I used <a href="https://github.com/jacobtoye">@jacobtoye</a>&#39;s excellent control-style toolbar as the inspiration and the spec for Leaflet.toolbar, and I was constantly tabbing back to Leaflet.draw to check the functionality of the Leaflet.draw toolbars. I worked on porting the Leaflet.draw toolbar interface over to <code>Leaflet.toolbar</code> as I was developing <code>Leaflet.toolbar</code>, which helped maintain a tight feedback loop and informed the features I was building in to Leaflet.toolbar. If anything made my job difficult, it was that <a href="https://github.com/jacobtoye">@jacobtoye</a> and the Leaflet.draw set the bar so high!</p>
<p>Thanks are in order to <a href="https://github.com/jacobtoye">@jacobtoye</a>, for a wonderful drawing plugin, and, of course, to <a href="https://github.com/mourner">@mourner</a>, for the amazing open-source mapping library that started it all.</p>
<h3 id="what-s-next">What&#39;s next</h3>
<p>If you&#39;re a Leaflet developer, I&#39;d love to hear your thoughts! Let me know what you think in the comments on <a href="https://github.com/Leaflet/Leaflet.draw/issues/324">issue #324 in Leaflet.draw</a>, or <a href="https://github.com/Leaflet/Leaflet.toolbar/issues">open a new issue on Leaflet.toolbar</a>.</p>

		</div>
	

</div><!-- .blog-posts -->
		<footer class="footer">
			<div class="social-media">
				<a href="www.linkedin.com/in/justinmanley/" target="_blank">
					<span class="fa fa-linkedin"></span>
				</a>
				<a href="https://github.com/justinmanley" target="_blank">
					<span class="fa fa-github"></span>
				</a>
				<a href="https://twitter.com/outoftheyards" target="_blank">
					<span class="fa fa-twitter"></span>
				</a>
				<a href="mailto:manleyjster@gmail.com" target="_blank">
					<span class="fa fa-envelope"></span>
				</a>		
			</div>
			<div class="attributions">
				<p>This site was generated on Jan 21st, 2016 with <a href="http://gruntjs.com/">Grunt</a> and <a href="http://assemble.io/">Assemble</a> using fonts and icons from <a href="http://glyphicons.com/">Glyphicons</a>, <a href="http://fortawesome.github.io/Font-Awesome/">Font Awesome</a>, and <a href="https://www.theleagueofmoveabletype.com/">The League of Moveable Type</a>.</p>
 

				<p><a href="./assets/images/favicon.ico">Favicon image</a> by AKoht on <a href="http://www.deviantart.com/">DeviantArt</a>, originally licensed <a href="http://creativecommons.org/licenses/by/4.0/">CC-BY</a>. </p>

			</div>		
		</footer>	
	</body>
</html>
