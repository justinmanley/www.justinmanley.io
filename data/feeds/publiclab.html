<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/006/340/medium/IMAG0382.jpg"/></div><div class="time">Tue, 19 Aug 2014 18:56:49 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/08-19-2014/mapknitter-annotations-riffle-data-as-map-annotations">MapKnitter Annotations: Riffle Data as Map Annotations</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/006/340/medium/IMAG0382.jpg'/><br /> ### What I want to do</p>
<p> I want to have a discussion about how we might embed Riffle data in MapKnitter as map annotations.</p>
<p> @mathew suggested in <a href="http://publiclab.org/notes/donblair/08-11-2014/research-note-workflows#c9933">this comment</a> that it might be possible to embed Riffle data in MapKnitter maps - which I thought was an awesome idea!</p>
<p> I think that the <em>goal</em> here is to enable users to upload data directly from Riffle sensors and have that data displayed on or beside the map in a way that will substantively augment the information payload of the map.</p>
<h3 id="what-i-ve-done">What I&#39;ve done</h3>
<p> I looked around the Public Lab website and found some research notes that discuss or use Riffle data. In particular: </p>
<p> <a href="http://publiclab.org/wiki/open-water">Wiki: Open Water</a>
 <a href="http://publiclab.org/wiki/riffle">Wiki: RIFFLE</a>
 <a href="http://publiclab.org/notes/walkerjeffd/08-11-2014/kayak-deployment-on-8-7-2014">Kayak Deployment on 8-7-2014</a></p>
<p> <a href="http://phd.walkerjeff.com/d3/hubbard/">Visualization by @WalkerJeffD</a>
 <a href="http://phd.walkerjeff.com/talks/20131105/baseflow.html">Baseflow separation visualization</a></p>
<p> I also found a <a href="http://i.publiclab.org/system/images/photos/000/002/567/original/ALB006.txt">sample data set</a> from a Riffle. [EDIT: Turns out that wasn&#39;t actually a RIFFLE data set. Here&#39;s a <a href="https://github.com/walkerjeffd/riffle-ito-apps/blob/master/analyses/20140807_kayak/data/LOGGER22.CSV">RIFFLE data set</a> from @WalkerJeffD. It&#39;s <em>much</em> more manageable!]</p>
<p> There&#39;s a <em>lot</em> of data here. I don&#39;t think it&#39;s feasible or even desirable to want to present the data set to the users in raw form, or even to try to visualize <em>all</em> of the data. I think it <em>would</em> be nice if we could create templates that automatically visualized one or two key parameters from the data.</p>
<p> The workflow / processsing pipeline that I envision is:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html User uploads Riffle data set (the data set above is in <code>.tsv.</code> format
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Built-in templates display Riffle directly on the map - no &quot;embedded&quot; charts or graphs - using d3 and Leaflet.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html A link to the data set is added to the sidebar so that viewers can click through and see the full, raw dataset.</p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/341/original/IMAG0381.jpg"><img src="http://i.publiclab.org/system/images/photos/000/006/341/medium/IMAG0381.jpg" alt="IMAG0381.jpg"/></a></p>
<h3 id="next-steps-additional-questions">Next Steps / Additional Questions</h3>
<p> The key question is: What default templates should we provide for visualizing the Riffle data? @mathew? @WalkerJeffD? @donblair? @warren? Let&#39;s start with a single data visualization. What is the data that will be most helpful to the most number of people? (I&#39;m thinking maybe temperature plotted against location, as @WalkerJeffD has done <a href="http://walkerjeffd.github.io/riffle-ito-apps/analyses/20140807_kayak/index.html#temperature-map">here</a>).</p>
<p> How flexible / extensible should this system be? Is it desirable to allow users to create their own custom visualizations using their own d3 and Leaflet code, or should we assume that users who are savvy enough to use d3 and Leaflet are savvy enough to do that kind of analysis on their own and publish it to GitHub, etc.</p>
<p> How much should users be able to customize the way that the data is displayed?</p>
</div></div>,<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/006/328/medium/Screenshot_from_2014-08-18_18_53_28.png"/></div><div class="time">Tue, 19 Aug 2014 00:03:58 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/08-19-2014/mapknitter-annotations-interface-refactoring-underway">MapKnitter Annotations: Interface Refactoring Underway</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/006/328/medium/Screenshot_from_2014-08-18_18_53_28.png'/><br /> ### Background ###</p>
<p> I am working to add rich annotation functionality to MapKnitter as part of Google Summer of Code (read about my project here: <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal</a>). This is my ninth week of coding.</p>
<p> The goal of this research note is to provide an update to the community on my progress with refactoring the MapKnitter interface.</p>
<p> If you&#39;re interested in reading about <code>Leaflet.Illustrate</code>, the Leaflet plugin that I wrote over the past few weeks to power MapKnitter&#39;s annotations, you can check out my <a href="http://publiclab.org/notes/justinmanley/07-29-2014/mapknitter-annotations-version-0-0-2-released-with-l-illustrate-textbox-and-l-illustrate-pointer">last research note</a>.</p>
<p> You can check out our previous discussion of this interface refactorinng in my previous research note:</p>
<p> <a href="http://publiclab.org/notes/justinmanley/08-06-2014/mapknitter-annotations-interface-refactoring">August 6, 2014 - MapKnitter Annotations: Interface Refactoring</a> </p>
<h3 id="progress">Progress</h3>
<p> Screenshot with Vidun&#39;s upload modal!</p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/329/original/Screenshot_from_2014-08-18_19_00_27.png"><img src="http://i.publiclab.org/system/images/photos/000/006/329/medium/Screenshot_from_2014-08-18_19_00_27.png" alt="Screenshot_from_2014-08-18_19_00_27.png"/></a></p>
<h4 id="overview">Overview</h4>
<p> So far, I have:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Added commenting and tagging to MapKnitter maps
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Begun integrating @vidun&#39;s work on the upload interface</p>
<p> Under the hood, I&#39;ve done a lot of work to make it easier for future developers to improve MapKnitter. I&#39;ve: </p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Set up <a href="http://bundler.io/">Bundler</a> to handle MapKnitter&#39;s&#39; dependencies
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Set up <a href="https://github.com/sstephenson/sprockets">Sprockets</a> and <a href="bower.io">bower</a> for handling all of MapKnitter&#39;s static assets.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Given MapKnitter a RESTful API using Rails&#39; resourceful routes.</p>
<h4 id="commenting-and-tagging">Commenting and Tagging</h4>
<p> I borrowed a <em>lot</em> of the commenting and tagging functionality from the Public Lab website. That means that commenting and tagging works pretty much the same in MapKnitter as it does on Public Lab. Among other things, users can write comments <em>and</em> the descriptions of their maps in Markdown.</p>
<h4 id="sprockets-bower">Sprockets &amp; bower</h4>
<p> MapKnitter&#39;s static assets were a <em>mess</em> before this. </p>
<p> MapKnitter uses quite a few third-party libraries: Bootstrap, JQuery-Fileupload, Leaflet, Leaflet.Draw, etc. Using bower will make it clearer which javascript and css files are maintained by third parties and easier to upgrade to newer versions.</p>
<p> Using Sprockets enables MapKnitter to handle static assets in a much more elegant and maintanable way. Because this method of asset pipelining is the default in Rails 3.1+, this will also make it much easier should Public Lab ever upgrade MapKnitter to a more modern version of Ruby or Rails.</p>
<p> I found these articles helpful for integrating MapKnitter with Sprockets:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <a href="http://pivotallabs.com/giving-rails-2-the-asset-pipeline-/">Giving Rails 2 the Asset Pipeline</a>
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <a href="http://jaredonline.github.io/blog/2012/05/16/sprockets-2-with-rails-2-dot-3/">Sprockets 2 With Rails 2.3</a>
 (most of the code hooking Sprockets in MapKnitter is copied directly from here).</p>
<h4 id="restful-api">RESTful API</h4>
<p> MapKnitter was previously <em>not</em> RESTful. Most significantly, resources were created, modified, and deleted using HTTP POST requests (as opposed to POST, PUT, and DELETE requests, respectively). Providing a RESTful API for MapKnitter will enable folks to use MapKnitter from the command line with <code>curl</code>. More importantly, it makes the code clearer, more logical, and more maintainable. For example, the <a href="https://github.com/manleyjster/mapknitter/blob/annotation-interface/config/routes.rb">routes</a> can now be declared as: </p>
<p> app.resources :maps do |maps|
 maps.resources :tags
 maps.resources :comments
 maps.resources :uploads
 end</p>
<h3 id="todo">TODO</h3>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Integrate Vidun&#39;s work on the MapKnitter upload interface. I&#39;ve already merged Vidun&#39;s work into my MapKnitter branch, so now it&#39;s a matter of making sure everything works with the new routes, etc.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Merge Anish&#39;s LeafletImageDistort plugin.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Push MapKnitter site to beta server that @dogi set up for beta testing by MapKnitter community. (It will be ready for </p>
<p> beta-testing as soon as I merge Vidun and Anish&#39;s work).</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Integrate the annotation features that I have developed in <code>Leaflet.Illustrate</code>. This will mean adding methods to <code>Leaflet.Illustrate</code> to serialize annotations to GeoJSON, adding routes, models, and controllers for annotations, and designing an annotation toolbar that will allow folks to change the colors and styles of polyline, polygon, and text annotations.</p>
<p> I am also interested in enable users to add Riffle data to the map as annotations, so I&#39;d like to talk to @mathew and others to figure out how to best implement this.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Create a workflow for generating Public Lab research notes from MapKnitter maps. This means generating an HTML POST query from MapKnitter map data that will be submitted to the Public Lab website to create a research note.</p>
</div></div>,<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/006/101/medium/note1.png"/></div><div class="time">Wed, 06 Aug 2014 20:03:19 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/08-06-2014/mapknitter-annotations-interface-refactoring">MapKnitter Annotations: Interface Refactoring</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/006/101/medium/note1.png'/><br /> ### Background ###</p>
<p> I am working to add rich annotation functionality to MapKnitter as part of Google Summer of Code (read about my project here: <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal</a>). This is my seventh week of coding.</p>
<p> If you&#39;re interested in reading about <code>Leaflet.Illustrate</code>, the Leaflet plugin that I wrote over the past few weeks to power MapKnitter&#39;s annotations, you can check out my <a href="http://publiclab.org/notes/justinmanley/07-29-2014/mapknitter-annotations-version-0-0-2-released-with-l-illustrate-textbox-and-l-illustrate-pointer">last research note</a>.</p>
<p> The goal of this research note is to post some of my ideas for refactoring the MapKnitter interface to expose annotation functionality and solicit feedback from the community.</p>
<h3 id="areas-for-improvement">Areas for Improvement</h3>
<p> The MapKnitter interface currently looks like this:</p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/091/original/interface-combined.png"><img src="http://i.publiclab.org/system/images/photos/000/006/091/medium/interface-combined.png" alt="interface-combined.png"/></a></p>
<p> I think that there are several areas for improvement with this interface:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html I love the way that the MapKnitter homepage presents a selection of recent maps. I think this is an awesome way to hook people in and communicate what MapKnitter is about. However, once a user clicks on a map, they are taken to an overview page for the map, not the map itself. Often, this overview <strong>doesn&#39;t even show the map itself</strong>.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html It is clear to me from looking through the archives that users seldom use the &quot;description&quot; field when creating a map. Furthermore, right now, the &quot;description&quot; field is <em>worse</em> than useless because most are populated by spam text.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Export functionality is scattered all over: right now, there are no fewer than <strong>three</strong> places on the overview page to export the map.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html The overview page doesn&#39;t make it easy to view or edit the map metadata (such as the base satellite layer), description, place, or image metadata.</p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/096/original/interface-commentary.png"><img src="http://i.publiclab.org/system/images/photos/000/006/096/medium/interface-commentary.png" alt="interface-commentary.png"/></a></p>
<h3 id="ideas-for-improvements">Ideas for Improvements</h3>
<p> It may not be possible to eliminate the overview page entirely, but I would like to move as much functionality as possible into the map editing interface so that the full-screen, full-functionality view of the map is the main destination for all users. This full-screen view of the map should be a self-explaining, self-documenting view of the map.</p>
<p> Some sketches: </p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/097/original/note1.png"><img src="http://i.publiclab.org/system/images/photos/000/006/097/medium/note1.png" alt="note1.png"/></a></p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/098/original/note2.png"><img src="http://i.publiclab.org/system/images/photos/000/006/098/medium/note2.png" alt="note2.png"/></a></p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/099/original/mapknitter-interface-sketch.png"><img src="http://i.publiclab.org/system/images/photos/000/006/099/medium/mapknitter-interface-sketch.png" alt="mapknitter-interface-sketch.png"/></a></p>
<h3 id="mockup">Mockup</h3>
<p> I built a preliminary implementation of the interface I sketched above. It&#39;s in the <a href="https://github.com/manleyjster/mapknitter/tree/annotation-interface"><code>annotations-interface</code> branch</a> of my fork of mapknitter - controllers and views are called <code>map2</code>.</p>
<p> <a href="http://i.publiclab.org/system/images/photos/000/006/100/original/mapknitter_interface.png"><img src="http://i.publiclab.org/system/images/photos/000/006/100/medium/mapknitter_interface.png" alt="mapknitter_interface.png"/></a></p>
<h3 id="feedback">Feedback</h3>
<p> Let me know what you think about taking the MapKnitter interface in this direction. Obviously there&#39;s a <em>lot</em> more that needs to be built in to provide full-featured annotation functionality - but what do you think of combining the overview and editing pages and the split-screen editing page?</p>
</div></div>,<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/005/650/medium/header.png"/></div><div class="time">Tue, 29 Jul 2014 07:02:01 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/07-29-2014/mapknitter-annotations-version-0-0-2-released-with-l-illustrate-textbox-and-l-illustrate-pointer">MapKnitter Annotations: Version 0.0.2 released with L.Illustrate.Textbox and L.Illustrate.Pointer</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/005/650/medium/header.png'/><br /> ### Background ###</p>
<p> I am working to add rich annotation functionality to MapKnitter as part of Google Summer of Code (read about my project here: <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal</a>). This is my sixth week of coding. The purpose of this research note is to provide an update on my progress with implementing text annotation for Leaflet.</p>
<p> To trace the discussions that have led me up to this point, you can look back through the following research notes, listed in chronological order.</p>
<p> March 18, 2014 - <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">MapKnitter Annotations Using Fabric.js (GSoC 2014 Proposal)</a></p>
<p> June 17, 2014 - <a href="http://publiclab.org/notes/justinmanley/06-17-2014/mapknitter-annotations-plugin-preliminary-specification">MapKnitter Annotations Plugin: Preliminary Specification</a></p>
<p> June 25, 2014 - <a href="http://publiclab.org/notes/justinmanley/06-25-2014/mapknitter-annotations-update-l-illustrate-textbox">MapKnitter Annotations Update: L.Illustrate.Textbox</a></p>
<p> July 2, 2014 - <a href="http://publiclab.org/notes/justinmanley/07-02-2014/mapknitter-annotations-textbox-rotation-using-css-transforms">MapKnitter Annotations: Textbox Rotation using CSS Transforms</a></p>
<p> July 14, 2014 - <a href="http://publiclab.org/notes/justinmanley/07-14-2014/mapknitter-annotations-leaflet-illustrate-edithandle-and-leaflet-illustrate-pointer">MapKnitter Annotations: Leaflet.Illustrate.EditHandle and Leaflet.Illustrate.Pointer</a></p>
<p> You can view the <a href="https://github.com/manleyjster/Leaflet.Illustrate">code for Leaflet.Illustrate on GitHub</a> and you can view a demo using the version of Leaflet.Illustrate (0.0.2) released along with this research note on GitHub at <a href="http://manleyjster.github.io/Leaflet.Illustrate/examples/0.0.2/simple/">http://manleyjster.github.io/Leaflet.Illustrate/examples/0.0.2/simple/</a>:</p>
<h3 id="progress">Progress</h3>
<p> <code>Leaflet.Illustrate</code> is done! </p>
<p> Well, maybe not done. <code>Leaflet.Illustrate</code> has reached the point where it can provide basic text annotation capability to the MapKnitter community, so I figure it&#39;s a good time to start integrating it with MapKnitter. There&#39;s still much that can be done to improve <code>Leaflet.Illustrate</code> to ensure that it is a fast, robust, and dependable library for Leaflet text annotation. Specifically:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Tooltip text should be added to <code>Leaflet.Illustrate.tooltipText</code> to guide users through the annotation process
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <code>Leaflet.Illustrate.PointerHandle</code> should be refactored into two subclasses: <code>Leaflet.Illustrate.PointerVertexHandle</code> and <code>Leaflet.Illustrate.PointerMidpointHandle</code>
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html All <code>Leaflet.Illustrate</code> code should be reviewed for instances of <code>L.Point</code> arithmetic, and, where possible, arithmetic methods should be replaced by their underscore-prefixed cousins (i.e. <code>L.Point._add</code> should be used instead of <code>L.Point.add</code>). This is purely for efficiency.</p>
<p> Here&#39;s what I&#39;ve been up to since I last posted:</p>
<h4 id="leaflet-illustrate-textbox">Leaflet.Illustrate.Textbox</h4>
<p> I fixed the <a href="http://publiclab.org/notes/justinmanley/07-14-2014/mapknitter-annotations-leaflet-illustrate-edithandle-and-leaflet-illustrate-pointer#Current+Challenges+and+TODO">annoying flickering</a> with the pointer connecting the rotate handle to the textbox in editing mode by making the pointer an instance of <code>L.Illustrate.Pointer</code>. Of course, this required implementing <code>L.Illustrate.Pointer</code> from scratch - more on this below.</p>
<p> I was also able to fix text selection and cursor placement in textboxes by calling <code>L.DomEvent.stopPropagation</code> on <code>mousedown</code>, <code>mousemove</code>, and <code>mouseup</code> events from the <code>&lt;textarea&gt;</code>, thanks to a helpful suggestion from <a href="https://github.com/danzel">@danzel</a> on the GitHub issue I posted: <a href="https://github.com/Leaflet/Leaflet/issues/2813">How do I get text selection working for a textarea on top of the map?</a>. </p>
<p> I encapsulated this functionality as <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/core/L.Illustrate.Textbox.js#L148"><code>L.Illustrate.Selectable</code></a>. However, I still feel (as I wrote in the GitHub issue thread) that <code>L.Illustrate.Selectable</code> should be unecessary, as this should be taken care of by <a href="https://github.com/Leaflet/Leaflet/blob/stable/src/dom/Draggable.js#L39"><code>map.dragging.disable()</code></a> or by calling <a href="https://github.com/Leaflet/Leaflet/blob/stable/src/dom/DomUtil.js#L254"><code>L.DomUtil.enableTextSelection</code></a> directly.</p>
<h4 id="leaflet-illustrate-pointer">Leaflet.Illustrate.Pointer</h4>
<p> I spent a lot of my time over the past two weeks implementing <code>L.Illustrate.Pointer</code>. A pointer is a line with only a single geographically-fixed point (the &quot;anchor&quot; point). The coordinates of the line are given in pixels with respect to the anchor point. The line thus maintains constant size through zoom events (it does not scale with the map):</p>
<pre><code> new L.Illustrate.Pointer(
 &lt;LatLng&gt; anchor, 
 &lt;Point[]&gt; coordinates, 
 &lt;Polyline options&gt; options?
 )
</code></pre><p> The immediate purpose for the <code>L.Illustrate.Pointer</code> class was to provide a robust pointer for <code>L.Illustrate.Textbox</code> (see above), but <code>L.Illustrate.Pointer</code> can serve as a general-purpose pointer linking any large annotation to a single point on the map.</p>
<p> A few notes on the design of <code>L.Illustrate.Pointer</code>:</p>
<p> Each instance of <code>L.Illustrate.Pointer</code> has <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/core/L.Illustrate.Pointer.SVG.js#L23">its own containing <code>&lt;svg&gt;</code> element</a>. This was done so that pointers would zoom smoothly using CSS3 transitions (CSS properties can only be applied to <code>&lt;svg&gt;</code> elements, and not their <code>&lt;g&gt;</code> or <code>&lt;path&gt;</code> children), since pointers with different anchor points would require different <code>css-transform</code> translations. It is possible that this will raise performance issues if there are <em>lots</em> of pointers on the map, but I think that for most of our use cases it will present no issues.</p>
<p> In other respects, much of the code for <code>L.Illustrate.Pointer</code> is borrowed directly from <a href="https://github.com/Leaflet/Leaflet/blob/stable/src/layer/vector/Path.js"><code>L.Path</code></a>, <a href="https://github.com/Leaflet/Leaflet/blob/stable/src/layer/vector/Path.SVG.js"><code>L.Path.SVG</code></a>, and <a href="https://github.com/Leaflet/Leaflet/blob/stable/src/layer/vector/Polyline.js"><code>L.Polyline</code></a> when it was not possible for it to inherit from them explicitly.</p>
<p> As it turns out, the editing handles for <code>L.Illustrate.Pointer</code> were <em>much</em> more difficult to design than those for <code>L.Illustrate.Textbox</code>. This is because the position of an editing handle for <code>L.Illustrate.Textbox</code> is fixed: a handle which starts out at the upper left corner will always be at the upper left corner (disregarding rotations). Editing handles for polylines, by contrast, can change position as vertices are added and deleted - and throughout, they must be in exact correspondence with the coordinates of the polyline so that dragging a handle updates the correct vertex.</p>
<p> My approach, similar to the approach I used for <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/edit/handles/L.Illustrate.RotateHandle.js"><code>L.Illustrate.RotateHandle</code></a>, etc. - but different from <a href="https://github.com/jacobtoye">@jacobtoye</a>&#39;s approach in <a href="https://github.com/Leaflet/Leaflet.draw">Leaflet.draw</a>, was to delegate as much as possible of the UI logic to the handles themselves.</p>
<p> The way I ended up implementing this was that <code>drag</code> or <code>click</code> events on a handle call the <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/v0.0.2/src/edit/L.Illustrate.Edit.Pointer.js#L75"><code>_addVertex</code></a>, <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/v0.0.2/src/edit/L.Illustrate.Edit.Pointer.js#L48"><code>_removeVertex</code></a>, or <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/v0.0.2/src/edit/L.Illustrate.Edit.Pointer.js#L95"><code>_updateVertex</code></a> methods of <code>L.Illustrate.Edit.Pointer</code>. These methods of <code>L.Illustrate.Edit.Pointer</code> handle the creation and destruction of instances of <code>L.Illustrate.PointerHandle</code> as necessary to add and remove vertices from the pointer. Once this is complete, the method fires an <code>edit:add-vertex</code>, <code>edit:remove-vertex</code>, or <code>edit:update-vertex</code> event. Instances of <code>L.Illustrate.PointerHandle</code> listen for these events and each is responsible for updating its own <code>_id</code> property (the <code>_id</code> property indicates which vertex the handle controls).</p>
<p> My hope was that implementing editing handles in this way would enable the editing handles to be highly decoupled from <code>L.Illustrate.Pointer</code> and <code>L.Illustrate.Edit.Pointer</code>. I think that the implementation was relatively successful from that perspective - but it is excessively complicated by the need for each handle to maintain an accurate internal <code>_id</code> property linking it to the correct coordinate. This might be simplified by splitting <code>L.Illustrate.PointerHandle</code> into two separate classes and giving each vertex handle responsibility for the midpoint handles to either side.</p>
<h4 id="miscellaneous-updates">Miscellaneous Updates</h4>
<p> Since my last research note, I completed a number of housekeeping tasks:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Connected <code>Leaflet.Illustrate</code> repo to <a href="https://travis-ci.org/manleyjster/Leaflet.Illustrate">Travis CI</a>
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Connected <code>Leaflet.Illustrate</code> repo to <a href="https://coveralls.io/r/manleyjster/Leaflet.Illustrate">Coveralls</a>
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Published <code>Leaflet.Illustrate</code> to <code>npm</code> as <a href="https://www.npmjs.org/package/leaflet-illustrate"><code>leaflet-illustrate</code></a>
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Added release tags for v0.0.1 and v0.0.2 in git
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Added build, coverage, and version badges to the <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/README.md"><code>README</code></a>.</p>
<p> It is my hope that these additions will give others confidence in the quality of this Leaflet plugin and encourage them to contribute or to use it for their own projects.</p>
<h3 id="next-steps-future-improvements">Next Steps &amp; Future Improvements</h3>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Fork MapKnitter repo and begin working on integrating <code>Leaflet.Illustrate</code> into MapKnitter.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Refactor <code>L.Illustrate.PointerHandle</code>
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Extend <code>L.Illustrate.Toolbar</code> to provide an intuitive interface for users to change the color, font, font-size, and other styles on the textbox and other features.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Implement <code>toGeoJSON</code> methods for <code>L.Illustrate.Pointer</code> and <code>L.Illustrate.Textbox</code> (will probably use <code>toGeoJSON</code> to serialize these objects for storage in the MapKnitter database)
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Allow textboxes to be fixed at points other than their center points
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Fix feature deletion button in toolbar</p>
</div></div>,<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/005/260/medium/chicagooooo.png"/></div><div class="time">Mon, 14 Jul 2014 07:23:26 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/07-14-2014/mapknitter-annotations-leaflet-illustrate-edithandle-and-leaflet-illustrate-pointer">MapKnitter Annotations: Leaflet.Illustrate.EditHandle and Leaflet.Illustrate.Pointer</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/005/260/medium/chicagooooo.png'/><br /> ### Background ###</p>
<p> I am working to add rich annotation functionality to MapKnitter as part of Google Summer of Code (read about my project here: <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal</a>). This is my fourth week of coding. The purpose of this research note is to provide an update on my progress with implementing text annotation for Leaflet.</p>
<p> To trace the discussions that have led me up to this point, you can look back through the following research notes, listed in chronological order.</p>
<p> March 18, 2014 - <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">MapKnitter Annotations Using Fabric.js (GSoC 2014 Proposal)</a></p>
<p> June 17, 2014 - <a href="http://publiclab.org/notes/justinmanley/06-17-2014/mapknitter-annotations-plugin-preliminary-specification">MapKnitter Annotations Plugin: Preliminary Specification</a></p>
<p> June 25, 2014 - <a href="http://publiclab.org/notes/justinmanley/06-25-2014/mapknitter-annotations-update-l-illustrate-textbox">MapKnitter Annotations Update: L.Illustrate.Textbox</a></p>
<p> July 2, 2014 - <a href="http://publiclab.org/notes/justinmanley/07-02-2014/mapknitter-annotations-textbox-rotation-using-css-transforms">MapKnitter Annotations: Textbox Rotation using CSS Transforms</a></p>
<p> You can view the <a href="https://github.com/manleyjster/Leaflet.Illustrate">code for Leaflet.Illustrate on GitHub</a> and you can view a demo using the version of Leaflet.Illustrate (0.0.1) released along with this research note on GitHub at <a href="http://manleyjster.github.io/Leaflet.Illustrate/examples/0.0.1/simple/">http://manleyjster.github.io/Leaflet.Illustrate/examples/0.0.1/simple/</a>:</p>
<h3 id="progress">Progress</h3>
<p> Since I last posted a research note, I have successfully implemented rotatable textboxes (using CSS transforms as I <a href="http://publiclab.org/notes/justinmanley/07-02-2014/mapknitter-annotations-textbox-rotation-using-css-transforms">proposed in a previous research note</a>) which behave correctly and consistently during map zoom and handles for rotating, resizing, and moving textboxes.</p>
<p> In order to implement these features, I have implemented the following classes, many of which are general-purpose extensions of Leaflet core functionality.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/extends-core/L.RotatableMarker.js#L1"><code>L.RotatableMarker</code></a> (extends <a href="https://github.com/Leaflet/Leaflet/blob/master/src/layer/marker/Marker.js"><code>L.Marker</code></a>)</p>
<p> Since textboxes (<a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/L.Illustrate.Textbox.js"><code>L.Illustrate.Texbox</code></a>) are created as instances of <code>L.Marker</code> with HTML icons supplied by <a href="https://github.com/Leaflet/Leaflet/blob/master/src/layer/marker/DivIcon.js#L6"><code>L.DivIcon</code></a>, this is the class which makes textboxes rotatable. The editing handles rotate along with their companion textbox, and so also derive from L.RotatableMarker.</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/edit/L.Illustrate.EditHandle.js"><code>Leaflet.Illustrate.EditHandle</code></a> (extends <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/extends-core/L.RotatableMarker.js#L1"><code>L.RotatableMarker</code></a>)</p>
<p> A handle is a marker attached to a companion shape. A handle:</p>
<ol>
<li>Is positioned with respect to its companion shape. The position of the handle is given as an offset in pixel coordinates from the center of its companion shape. The offset is given as an <code>L.Point</code> object, and its geographic position (latlng) is managed internally. Note that the geographic position (latlng) of the handle usually changes during zooming, since the textbox maintains constant pixel size during zoom.</li>
<li><p>Responds to drag events to alter the state of the textbox (classes which extend <code>Leaflet.Illustrate.EditHandle</code> must implement <code>_onHandleDrag</code> (for example, in <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/edit/L.Illustrate.ResizeHandle.js#L11"><code>Leaflet.Illustrate.ResizeHandle</code></a>).</p>
<p>The key purpose of the <code>Leaflet.Illustrate.EditHandle</code> class is to allow applications to create markers which must maintain a fixed pixel position with respect to a given <code>latlng</code>.</p>
<p>Child classes <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/edit/L.Illustrate.RotateHandle.js"><code>Leaflet.Illustrate.RotateHandle</code></a>, <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/edit/L.Illustrate.ResizeHandle.js#L1"><code>Leaflet.Illustrate.ResizeHandle</code></a>, and <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/edit/L.Illustrate.MoveHandle.js"><code>Leaflet.Illustrate.MoveHandle</code></a> all inherit from <code>Leaflet.Illustrate.EditHandle</code>.</p>
<p>I&#39;ve also implemented several utility methods extending Leaflet core which are worth noting:</p>
<p>Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/extends-core/L.DomUtil.getRotateString.js"><code>L.DomUtil.getRotateString(angle, units)</code></a></p>
<p>Returns a CSS transform string corresponding to the given angle. The units (<a href="http://www.impressivewebs.com/alternative-units-css3-rotate-transforms/">radians, degrees, turns, or gradians</a>) must be given explicitly. This complements the method <code>L.DomUtil.getTranslateString</code> already defined in <code>L.DomUtil</code>.</p>
<p>Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/extends-core/L.DomUtil.setTransform.js"><code>L.DomUtil.setTransform(el, point, angle, disable3D)</code></a></p>
<p>Sets the <code>transform</code> property on the given HTML element <code>el</code> for the given offset (<code>point</code>), and rotation (<code>angle</code>). If disable3D is set, then there is no rotation (rotation only works in browsers which support CSS transforms).</p>
<p>Leaflet core provides only the method <a href="https://github.com/Leaflet/Leaflet/blob/master/src/dom/DomUtil.js#L146"><code>L.DomUtil.setPosition</code></a>, which sets the absolute position of the given element using either the css-transform <code>translate</code> function or, if <code>disable3D</code> is false, setting the <code>top</code> and <code>left</code> properties on the element. When <code>disable3D</code> is set, <code>L.DomUtil.setPosition</code> just sets the css-transform property to the newly calculated translate string, and, in the process, overwrites any rotation also set using the css-transform property. This new method <code>L.DomUtil.setTransform</code> solves this by setting <em>both</em> the translate and rotate property as appropriate.</p>
<p>There are undoubtedly ways to optimize this. Ultimately, we think about translation and rotation as separate operations, and so it would be nice if the abstraction provided by Leaflet supported this. This could be done by implementing <code>L.DomUtil.setTranslation</code> and <code>L.DomUtil.setRotation</code>, each of which would parse the css-transform string and reset <em>only</em> the parameters of the appropriate translate function. Further (relatively simple) optimizations would be to delete the transform functions when unnecessary (i.e. <code>rotate(0,0,0,0)</code> could be deleted).</p>
<h3 id="current-challenges-and-todo">Current Challenges and TODO</h3>
<p>I&#39;ve completed the bulk of the work that has to be done to implement textboxes. There are quite a number of small, but crucial tasks that remain before these textboxes are truly usable.</p>
<p>Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Add remove hooks for edit handles (implement <code>onRemove</code> or <code>removeHooks</code>)
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Coordinate textbox focus, dragging, and text selection (it is not currently possible to select text in the textbox because of how Leaflet overrides default drag behavior within the map container)
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Fix irritating flicker-on-zoom of the pointer indicating the position of the rotate handle
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Add tooltip text (<code>L.Illustrate.tooltipText</code> - the analogue of <a href="https://github.com/Leaflet/Leaflet.draw/blob/master/src/Leaflet.draw.js#L7"><code>L.drawLocal</code></a> in <code>Leaflet.draw</code>)
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Allow <code>L.Illustrate.Textbox</code> to be modified via styles given in the <code>options</code> object, <em>including</em> default text
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Finish implementing <code>L.Illustrate.Toolbar</code>. This may involve refactoring parts of <a href="https://github.com/Leaflet/Leaflet.draw/blob/master/src/Toolbar.js"><code>L.Toolbar</code></a>.</p>
<p>I&#39;ve been working for the past few days on eliminating the annoying flickering of the rotate handle pointer on zoom. It&#39;s turning out to be quite a thorny problem. Markers (<code>L.Marker</code>) and polylines (<code>L.Path</code>) are implemented very differently. The main difficulty is that each marker has an <code>_animateZoom</code> method which is called when the <code>zoomanim</code> event is fired. In writing <code>L.Illustrate.EditHandle</code>, I simply overrode the default <code>_animateZoom</code> method and reset the position of the handle during zoom in order to maintain constant pixel position with respect to the companion shape of the handle.</p>
</li>
</ol>
<p> <a href="http://i.publiclab.org/system/images/photos/000/005/261/original/aar84.gif"><img src="http://i.publiclab.org/system/images/photos/000/005/261/medium/aar84.gif" alt="aar84.gif"/></a></p>
<p> <em>Notice how the pointer for the rotate handle (perpendicular blue line on top) flickers on zoom.</em></p>
<p> Whether the polylines are drawn using Canvas, SVG, or VML (backwards-compatibility with IE), they are scaled during animation using <code>_animatePathZoom</code>, which is a method of the <code>L.Map</code> object, <em>not</em> a method of the polyline. The <code>_animatePathZoom</code> method resets the css-transform of the root <code>&lt;svg&gt;</code> element, translating and scaling <em>all</em> vector objects on the map by the same amount.</p>
<p> This is not what we want for a pointer.</p>
<p> Pointers should extend paths in the same way that handles extend markers. That is, a pointer is a path whose vertices are defined in <em>pixel</em> coordinates, given with respect to an origin which has a fixed geographic position.</p>
<p> After spending a fair amount of time on this, I think that the best way to approach the rotate handle pointer is to define a new class (<code>L.Illustrate.Pointer</code>) to encapsulate this functionality. Since each pointer will be scaled and translated differently during map zooming, each will need to be given its own <code>&lt;svg&gt;</code> root element.</p>
<p> I like this approach because it animates the paths during map zoom in the same way as Leaflet core (no need for <code>SMIL</code> or javascript animations). I&#39;m a bit concerned that adding many <code>&lt;svg&gt;</code> (one for each pointer) to the page will negatively impact performance, although this thread (<a href="https://groups.google.com/forum/#!topic/d3-js/ZJ6pznVU5LQ">How many SVGs before performance issues?</a>) suggests that, as long as there are tens to hundreds of pointers, that shouldn&#39;t be a big issue.</p>
<p> Implementing rotate handle pointers in this way will mean that <code>L.Illustrate.Pointer</code> can also be used for <em>any</em> kind of pointer meant to call out a single location or identify an annotation (like a textbox) with a single point on the map.</p>
<h3 id="next-steps">Next Steps</h3>
<p> Once the Leaflet.Illustrate plugin is usable, I can begin integrating it into MapKnitter. This will involve designing a toolbar (extending either <code>L.Draw.Toolbar</code> or <code>L.Toolbar</code>) to expose the annotation functionality of <code>Leaflet.draw</code> and <code>Leaflet.Illustrate</code> to users and then integrating this toolbar into MapKnitter, among other things.</p>
</div></div>,<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/005/077/medium/Screenshot_from_2014-07-01_20_15_19_copy.png"/></div><div class="time">Wed, 02 Jul 2014 01:16:59 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/07-02-2014/mapknitter-annotations-textbox-rotation-using-css-transforms">MapKnitter Annotations: Textbox Rotation using CSS Transforms</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/005/077/medium/Screenshot_from_2014-07-01_20_15_19_copy.png'/><br /> ### Background ###</p>
<p> I am working to add rich annotation functionality to MapKnitter as part of Google Summer of Code (read about my project here: <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal</a>). This is my second week of coding. The purpose of this research note is to provide an update on my progress with implementing text annotation for Leaflet.</p>
<p> To trace the discussions that have led me up to this point, you can look back through the following research notes, listed in chronological order.</p>
<p> March 18, 2014 - <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">MapKnitter Annotations Using Fabric.js (GSoC 2014 Proposal)</a></p>
<p> June 17, 2014 - <a href="http://publiclab.org/notes/justinmanley/06-17-2014/mapknitter-annotations-plugin-preliminary-specification">MapKnitter Annotations Plugin: Preliminary Specification</a></p>
<p> June 25, 2014 - <a href="http://publiclab.org/notes/justinmanley/06-25-2014/mapknitter-annotations-update-l-illustrate-textbox">MapKnitter Annotations Update: L.Illustrate.Textbox</a></p>
<h3 id="progress">Progress</h3>
<p> The first step in my project is implementing basic text annotation for Leaflet. My solution to text annotation for Leaflet uses a textbox-based UI for text annotation which should be familiar to users of Powerpoint, Photoshop, and many other image-editing programs. I am currently developing this functionality in a plugin for Leaflet, <a href="https://github.com/manleyjster/Leaflet.Illustrate">Leaflet.Illustrate</a> which extends <a href="https://github.com/Leaflet/Leaflet.draw">Leaflet.draw</a>.</p>
<p> <a href="http://publiclab.org/profile/mathew">Mathew</a> and I determined in <a href="http://publiclab.org/notes/justinmanley/06-25-2014/mapknitter-annotations-update-l-illustrate-textbox#comments-container">discussion over my last research note</a> that rotatable text was part of the core needs that this plugin aims to address. At the time, I thought that rotatable text would have to be implemented using SVG. After our discussion, I realized that another option could be to use <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/transform">CSS transforms</a> on HTML text. I decided to go ahead with this, rather than jumping directly into an SVG implementation (which would likely have involved extending Leaflet&#39;s core for vector layers), since it seemed that HTML textboxes using CSS transforms would be both easier to implement and more user-friendly for application developers.</p>
<p> This week, I successfully implemented rotatable HTML textboxes using <a href="http://leafletjs.com/reference.html#divicon">L.DivIcon</a> and CSS transforms. You can view a demo of the functionality below: </p>
 <iframe width=100% height="390" src="//www.youtube.com/embed/a4wf2EvSW6c" frameborder="0" allowfullscreen></iframe>

<p> The code that makes the rotation happen is copied below:</p>
<p> function _updateRotation() {
 var degrees = Math.round(this._rotation*(180/Math.PI)),
 rotationString = &quot;rotate(&quot; + degrees + &quot;deg)&quot;,
 size = this.getSize(),
 translateString = &quot;&quot;,
 center;</p>
<p> if (this._map) {
 center = this._map.latLngToContainerPoint(this._latlng);
 translateString = &quot;translate(&quot; + center.x + &quot;px, &quot; + center.y + &quot;px)&quot;;</p>
<p> this._textbox._icon.style[&quot;-webkit-transform-origin&quot;] = (center.x + Math.round(size.x/2)) + &quot;px &quot; + (center.y + Math.round(size.y/2)) + &quot;px&quot;;
 }</p>
<p> this._textbox._icon.style[&quot;-webkit-transform&quot;] = rotationString + &quot; &quot; + translateString;
 this._textbox._icon.style[&quot;-o-transform&quot;] = rotationString + &quot; &quot; + translateString;
 this._textbox._icon.style[&quot;-ms-transform&quot;] = rotationString + &quot; &quot; + translateString;
 this._textbox._icon.style[&quot;-moz-transform&quot;] = rotationString + &quot; &quot; + translateString;
 this._textbox._icon.style.transform = rotationString + &quot; &quot; + translateString;
 },</p>
<p> As the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/transform">MDN entry</a> notes, CSS transforms <em>are</em> an experimental technology, and that&#39;s why all of the vendor prefixes are required. But CSS transforms have been around for quite a while, are well-tested, and with the appropriate vendor prefixes, the basic 2D CSS transforms that I use above (rotate and translate), are supported by</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Chrome (all versions)
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Firefox 3.5+
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Internet Explorer 9.0+
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Opera 10.5+
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Safari 3.1+</p>
<p> (<a href="http://caniuse.com/transforms2d">click for a complete compatibility table</a>). I think that this will probably be sufficient for compatibility. If we <em>must</em> make it compatible with IE 8 and below, that can be done using Microsoft&#39;s <a href="http://msdn.microsoft.com/en-us/library/ms533014%28VS.85,loband%29.aspx">Matrix Filters</a>.</p>
<h3 id="issues">Issues</h3>
<p> I&#39;m not really sure why I needed the <code>translateString</code> and <code>transform-origin</code> properties in the code above - the <code>rotate</code> transform should have been enough. I think that the CSS transforms are interacting in a strange way with the <code>position: absolute</code> property that the textbox inherits from <code>L.Marker</code>. The code above works, but I would like to understand better the way that the CSS transforms are interacting with the positioning.</p>
<p> Currently, the rotation is undone on zooming in or out. This is because Leaflet positions markers using the CSS transform translate function. Whenever the user zooms, the translate values have to be recalculated and the <code>css-transform</code> property is reset, which overwrites the rotation and translation put in by <code>_updateRotation()</code>. The easiest way to fix this is probably to store the rotation string and then reset the <code>css-transform</code> property once the zoom completes.</p>
<p> It&#39;s impossible to select text inside the textbox right now. I think that this has to do with the handlers that Leaflet sets up for drag events occurring anywhere over the map. Even when I call <code>map.enableTextSelection()</code>, the <code>selectstart</code> event is never fired on the <code>&lt;textarea&gt;.</code> This is going to take some looking in to.</p>
<h3 id="next-steps">Next Steps</h3>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Add editing handles for resizing and moving (the video above implements a handle for rotation).
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Make textbox outline highlighting more natural
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Correct text selection issues.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Fix rotation on zoom.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Remove default <code>&lt;textarea&gt;</code> resizing behavior so that there is a single tool for resizing the textbox.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Fix disturbing flickering of the rotation handle when the marker reaches an angle of -&pi;/2.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Rotate handles along with the textbox</p>
</div></div>,<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/004/964/medium/illustrate-textbox.png"/></div><div class="time">Wed, 25 Jun 2014 05:49:58 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/06-25-2014/mapknitter-annotations-update-l-illustrate-textbox">MapKnitter Annotations Update: L.Illustrate.Textbox</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/004/964/medium/illustrate-textbox.png'/><br /> ### Background ###</p>
<p> I am working to add rich annotation functionality to MapKnitter as part of Google Summer of Code (read about my project here: <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal</a>). I just started coding this week, on Monday. The purpose of this research note is to provide an update on the approach that I&#39;ve chosen (see my <a href="http://publiclab.org/notes/justinmanley/06-17-2014/mapknitter-annotations-plugin-preliminary-specification">last research note</a>) for implementing basic annotation functionality.</p>
<h3 id="implementation-update">Implementation Update</h3>
<p> Last week, I was trying to decide whether to implement visual annotation for Leaflet using SVG or HTML canvas. After meeting with Jeff, we decided to go with SVG. This was for a number of reasons:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Leaflet core has built-in classes for handling SVG drawing (<a href="http://leafletjs.com/reference.html#rectangle">L.Rectangle</a>, <a href="http://leafletjs.com/reference.html#polyline">L.Polyline</a>, <a href="http://leafletjs.com/reference.html#circle">L.Circle</a>, etc), and there is already a high-quality drawing plugin, <a href="https://github.com/Leaflet/Leaflet.draw">Leaflet.draw</a>, which extends Leaflet core SVG functionality with an excellent UI.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html SVG performance profile is more appropriate. If a user started at a high zoom level, annotations could potentially cover a very large pixel area. Canvas performance degrades quickly with pixel area, while SVG performance is constant with respect to pixel area (SVG performance degrades in proportion to the number of objects).
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html SVG text looks better, and text annotation is one of the most fundamental visual annotation features that the MapKnitter community is looking for
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html We have more options for zooming/scaling behavior with SVG</p>
<p> Jeff and I talked about developing a Leaflet plugin containing the rich annotation functionality that we are looking for - functionality going beyond what is offered in Leaflet.draw. To this end, I&#39;ve begun development on a new Leaflet plugin, which I&#39;ve called Leaflet.Illustrate. Jeff and I threw around a bunch of names: Illuminate, Annotate, Explain, Uncover, Storyteller, Cartographer... We wanted a name that would communicate succinctly that the plugin is designed to allow and encourage users to mark up maps in ways that clarify the purpose and background of the map. Leaflet.Illustrate is a working name.</p>
<p> The first feature I&#39;ve begun to implement is text drawing. This functionality is contained in the classes <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/create/L.Illustrate.Create.Textbox.js">Leaflet.Illustrate.Create.Textbox</a> and <a href="https://github.com/manleyjster/Leaflet.Illustrate/blob/master/src/edit/L.Illustrate.Edit.Textbox.js">Leaflet.Illustrate.Edit.Textbox</a>, which, respectively, extend Leaflet.Edit.Rectangle and Leaflet.Draw.Rectangle (both exported by Leaflet.draw).</p>
<p> So far, I have added a &#39;Textbox&#39; button to the drawing toolbar which users can select to draw a textbox on the map. This will enable text annotation in the style of Powerpoint or Photoshop, in which a user designates a rectangular area in which to enable text entry. The textbox is composed of two elements: an SVG rectangle, drawn using L.Draw.Rectangle which displays the outline of the textbox, and an HTML <code>&lt;textarea&gt;</code> element inside of an <a href="http://leafletjs.com/reference.html#divicon">L.DivIcon</a>, where the user can enter text. Right now, users can draw a textbox and enter text in it. What remains to be done to round out basic textbox functionality is to:</p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Allow users to select text inside of the <code>&lt;textarea&gt;</code>. Currently, trying to select text inside the <code>&lt;textarea&gt;</code> only results in dragging the map.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Determine how the <code>&lt;textarea&gt;</code> will behave on zoom. Should it shrink along with the map, or maintain constant size on the screen?
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Correct that initial latlng position of the <code>&lt;textarea&gt;</code>.
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Make sure that the <code>&lt;textarea&gt;</code> resizes properly along with the SVG rectangle.</p>
<p> Some higher-level questions that have occurred to me at this point: </p>
<p> If I continue to implement textboxes using HTML <code>&lt;textarea&gt;</code> elements, then the L.Draw.Rectangle outline is not really necessary. If I want an outline to show up around the <code>&lt;textarea&gt;</code> when it is focused, I can do that easily using CSS. The weakness of using <code>&lt;textarea&gt;</code> elements is that, as far as I am aware, HTML elements cannot be rotated arbitrarily, which means that any text annotations on the map would always have to be oriented horizontally. I don&#39;t think this is necessarily a bad thing, since horizontally-oriented text is most readable. However, if there is a need in the community for text that can be rotated, then we will need to implement textboxes using SVG text elements. This will be more complicated, as it will most likely involve extending Leaflet core, which currently does not support SVG text, only SVG graphics.</p>
<p> Finally, I&#39;m not sure yet if it&#39;s really necessary to encapsulate all of this functionality in a separate Leaflet plugin. It may be sufficient to simply add functionality to Leaflet.draw. Leaflet.draw is conveniently designed in that the drawing functionality is only loosely coupled to the toolbar. The more that I think about it, the more it seems to me that, for MapKnitter, we don&#39;t really need that much new functionality - we just need existing functionality presented in a specific way (i.e. it&#39;s more of a UI problem than a plugin design problem). Accordingly, it may make the most sense to add a few classes to Leaflet.draw and then design a completely new and separate toolbar UI for MapKnitter. This will become clearer as I get further with my coding.</p>
<p> Weigh in! Let me know what you think of all this.</p>
</div></div>,<div class="event publiclab-event"><div class="thumbnail"><img src="http://i.publiclab.org/system/images/photos/000/004/823/medium/Barataria_12_june_trip_VI.png"/></div><div class="time">Tue, 17 Jun 2014 05:12:21 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/06-17-2014/mapknitter-annotations-plugin-preliminary-specification">MapKnitter Annotations Plugin: Preliminary Specification</a></div><div class="details"><p><img src='http://i.publiclab.org/system/images/photos/000/004/823/medium/Barataria_12_june_trip_VI.png'/><br /> ### Background ###</p>
<p> I am working to add rich annotation functionality to MapKnitter as part of Google Summer of Code (read about my project here: <a href="http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">http://publiclab.org/notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal</a>). I&#39;m about to start coding next week. The purpose of this research note is to:</p>
<ol>
<li>Enumerate precisely the annotation features that are desirable (in greater detail than in my proposal)</li>
<li>Discuss strategies for implementing these features</li>
<li><p>Determine whether raster or vector formats would be more suited to the type of annotation functionality that we are looking for. This will determine whether I use Fabric.js, which I had advocated in my proposal, or an SVG library - perhaps Snap.js.</p>
<h3 id="visual-annotations-specification">Visual Annotations Specification</h3>
<p>There are two types of annotations that I considered in my GSoC proposal: visual annotations (i.e. text, arrows, etc.), and rich media annotations - embedded images, videos from YouTube, or clips from SoundCloud. The first phase of my project is focused on basic visual annotations, so that&#39;s all I&#39;m going to discuss here; rich media annotations will come later.</p>
<p>After looking through a lot of Public Lab maps, these are the core annotation features that I think are needed: </p>
<h4 id="place-text-directly-on-the-map-">Place text directly on the map.</h4>
<p>Users should be able to control the size, color, and orientation of text. The text should sit directly on top of satellite images, as in this example: </p>
<p><a href="http://i.publiclab.org/system/images/photos/000/004/802/original/h2sexample.png"><img src="http://i.publiclab.org/system/images/photos/000/004/802/medium/h2sexample.png" alt="h2sexample.png"/></a>
(<a href="http://publiclab.org/notes/ewilder/06-16-2014/hydrogen-sulfide-photopaper-sensing-tool-development-notes">from ewilder&#39;s research note reporting on experiments using photopaper to test Hydrogen Sulfide levels</a>).</p>
<p>There&#39;s more on this in Mathew&#39;s research note from a few months ago: <a href="http://publiclab.org/notes/mathew/03-14-2014/mapknitter-annotations-gsoc">MapKnitter Annotations (GSOC)</a>.</p>
<h4 id="draw-small-circles-to-act-as-markers-and-circular-and-rectangular-outlines-to-frame-an-area-of-focus-">Draw small circles to act as markers and circular and rectangular outlines to frame an area of focus.</h4>
<p>As above, users should be able to control the color of the shapes and the weight of the outline. Users should also be able to control whether the shape is filled or only an outline.</p>
<p>For example: </p>
<p><a href="http://i.publiclab.org/system/images/photos/000/004/811/original/LAX_CO2.png"><img src="http://i.publiclab.org/system/images/photos/000/004/811/medium/LAX_CO2.png" alt="LAX_CO2.png"/></a></p>
<p>(from the <a href="http://scienceland.wikispaces.com/FLTS">From Lot To Spot Carbon Dioxide Mapping Project</a>)</p>
<p>and:</p>
<p><a href="http://i.publiclab.org/system/images/photos/000/004/822/original/bayou_manchac_sewer_outful.jpg"><img src="http://i.publiclab.org/system/images/photos/000/004/822/medium/bayou_manchac_sewer_outful.jpg" alt="bayou_manchac_sewer_outful.jpg"/></a></p>
<p>(from eustatic&#39;s <a href="http://publiclab.org/notes/eustatic/2-5-2013/bayou-manchac-map-sewerage-problem">Bayou Manchac map of sewerage problem</a> research note.</p>
<p><a href="http://i.publiclab.org/system/images/photos/000/004/597/original/5_1830_Tidmarsh_Farm_Map_with_notes.png"><img src="http://i.publiclab.org/system/images/photos/000/004/597/original/5_1830_Tidmarsh_Farm_Map_with_notes.png" alt="5_1830_Tidmarsh_Farm_Map_with_notes.png"/></a></p>
<p>(from eymund&#39;s research note <a href="http://publiclab.org/notes/eymund/06-10-2014/exploring-the-space-unseen-historic-resources-for-guiding-future-story-telling">Exploring The Space Unseen: Historic Resources For Guiding Future Story Telling</a>)</p>
<h4 id="draw-freely-">Draw freely.</h4>
<p><a href="http://i.publiclab.org/system/images/photos/000/004/717/original/Barataria_12_june_trip_VI.png"><img src="http://i.publiclab.org/system/images/photos/000/004/717/original/Barataria_12_june_trip_VI.png" alt="Barataria_12_june_trip_VI.png"/></a></p>
<h4 id="place-tooltips-simple-lines-to-indicate-small-landscape-features-">Place tooltips/simple lines to indicate small landscape features.</h4>
<p><a href="http://i.publiclab.org/system/images/photos/000/004/595/original/4_1890_USGS_Map_with_speculative_study_sites.png"><img src="http://i.publiclab.org/system/images/photos/000/004/595/original/4_1890_USGS_Map_with_speculative_study_sites.png" alt="4_1890_USGS_Map_with_speculative_study_sites.png"/></a></p>
<p>(from the same research note <a href="http://publiclab.org/notes/eymund/06-10-2014/exploring-the-space-unseen-historic-resources-for-guiding-future-story-telling">Exploring The Space Unseen: Historic Resources For Guiding Future Story Telling</a>).</p>
<p>Part of the idea behind placing text directly on the map is that this eliminates the need for a legend, because the integrated text does the job of the legend. However, there are some cases where a legend may still be desirable or necessary. It will be possible to make a legend using the above tools - rectangles, text, etc - but it might be worthwhile to create a dedicated legend functionality as part of the annotation tool.</p>
<h3 id="canvas-vs-svg">Canvas vs. SVG</h3>
<p>Most of the features above <em>could</em> be implemented using either vector graphics (SVG) or raster graphics (HTML <code>&lt;canvas&gt;</code> elements. I wrote in my GSoC proposal that I was planning on using Fabric.js, a Javascript library extending the HTML <code>&lt;canvas&gt;</code> technology, to implement the above features. However, I spoke to a software engineer at <a href="https://www.inventables.com/">Inventables</a>, which uses Fabric.js in their CNC milling software Easel, and he told me that Fabric.js has been frustrating for them to use - and that a lot of that comes from the fundamental nature of <code>&lt;canvas&gt;</code> elements.</p>
<p>One issue is that <code>&lt;canvas&gt;</code> elements are stateless. At any point in time, a <code>&lt;canvas&gt;</code> element is basically just a .png image. The only difference between <code>&lt;canvas&gt;</code> elements and images is that <code>&lt;canvas&gt;</code> elements can be dynamically written to using Javascript. Fabric.js adds an object-oriented abstraction layer on top of <code>&lt;canvas&gt;</code> and gives it a notion of state. But apparently (according to the engineer I spoke to, at least) - it&#39;s not perfect.</p>
<p>SVG has a much more natural notion of state. The disadvantage of SVG is that not all visual annotation functionality can be built naturally using SVG - for example, drawing freely is most naturally implemented using raster graphics, not vector graphics.</p>
<p>The performance of canvas <a href="http://smus.com/canvas-vs-svg-performance/">degrades in proportion to the number of pixels that must be drawn</a> (the size and resolution of the rendering area), while svg degrades in proportion to the number of objects. MapKnitter currently uses a combination of svg and canvas: Leaflet core uses <code>&lt;canvas&gt;</code> elements for rendering map tiles, but the <code>Leaflet.draw</code> plugin relies on svg. If a map is very large, then any naive <code>&lt;canvas&gt;</code>-based approach may run into performance issues. We could address these by lazily instantiating <em>small</em> canvas elements wherever a user clicks on the map with a drawing tool or by only allowing annotations within the bounding box of the uploaded aerial imagery (this could effectively solve any performance issues, since most MapKnitter projects describe a self-contained area).</p>
<h3 id="conclusions">Conclusions</h3>
<p>Right now, I&#39;m leaning towards using HTML <code>&lt;canvas&gt;</code> and Fabric.js, simply because it seems to be a much more natural solution to our annotation needs. However, I&#39;m open to other suggestions - let me know in the comments! If I went with svg, I would either use the <a href="http://snapsvg.io/">Snap.svg</a> library, or just hard-code it myself, since svg has a natural object model.</p>
<p>If I go with Fabric.js, then the features in the above specifications will correspond to Leaflet bindings for:</p>
<p>Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <code>Fabric.Circle</code>
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <code>Fabric.Rect</code>
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <code>Fabric.Polyline</code>
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html <code>Fabric.Text</code></p>
<p>at a minimum.</p>
<p>Let me know what you guys think! Also - did I leave anything out of the visual annotations specification? I think that I covered everything that we need, but please let me know if I left anything out.</p>
</li>
</ol>
</div></div>,<div class="event publiclab-event"><div class="time">Tue, 18 Mar 2014 10:12:27 +0000</div><div class="title"><a href="http://publiclab.org/profile/justinmanley">justinmanley</a><span>published</span><a href="http://publiclab.org//notes/justinmanley/03-18-2014/mapknitter-annotations-using-fabric-js-gsoc-2014-proposal">Mapknitter Annotations using Fabric.js (GSOC 2014 Proposal)</a></div><div class="details"><h2 id="mapknitter-annotations-gsoc-2014-proposal-">MapKnitter Annotations (GSOC 2014 Proposal)</h2>
<p> <strong>Name:</strong> Justin Manley</p>
<p> <strong>Affiliation:</strong> University of Chicago/ B.S. in Mathematics (third-year)</p>
<p> <strong>Location:</strong> Chicago, IL</p>
<p> <strong>Email:</strong> manleyjster@gmail.com</p>
<p> <strong>Phone:</strong> see email</p>
<p> <strong>Project I want to work on:</strong> MapKnitter</p>
<p> <strong>Project title:</strong> Add rich, narrative annotation functionality to Mapknitter using &lt;canvas&gt; elements and Fabric.js. </p>
<h3 id="what-the-mapknitter-community-needs">What the MapKnitter community needs</h3>
<p> Since 2012, members of the MapKnitter community have <a href="http://publiclab.org/notes/warren/5-15-2012/annotated-maps-roundup">expressed a desire</a> for an annotation tool built into the MapKnitter interface that would allow users building maps to add notes, arrows, drawings, and rich media content to maps in order to </p>
<p> Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Convey the purpose of their map
 Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html More effectively use their map as evidence to create an argument or tell a story</p>
<p> This desire was echoed again by <a href="http://publiclab.org/notes/shannon/1-9-2013/map-annotation-brainstorming-notes">the latest brainstorming session in 2013</a> and most recently in an <a href="http://publiclab.org/notes/mathew/03-14-2014/mapknitter-annotations-gsoc">excellent post</a> by @michael. As @michael notes, <a href="https://github.com/jywarren/mapknitter/commits/master/public/javascripts/annotation.js">work has begun</a> on an annotation tool for MapKnitter. However, this annotation toolkit only supports pop-up bubble notes attached to markers on the map. As @michael notes, both historically, and currently, people have annotated maps in a much richer and more immersive way. My project aims to enable rich annotations that are fully integrated into MapKnitter maps, following <a href="http://publiclab.org/wiki/gsoc-ideas#Add+an+annotations+layer+to+Mapknitter">this GSoC project idea</a>.</p>
<h3 id="what-i-want-to-do">What I want to do</h3>
<p> The goal of my project is to create a Leaflet plugin using HTML &lt;canvas&gt; elements along with Fabric.js to allow users to annotate Leaflet maps, and then to integrate this plugin into MapKnitter.</p>
<h4 id="specific-project-goals">Specific project goals</h4>
<ol>
<li>Integrate Fabric.js with Leaflet so that canvas and map can function separately, even as each canvas element is linked to a specific coordinate on the map. This will allow users to write and draw directly on the map.</li>
<li>Allow users to define a sequence of annotations (canvas elements). Combined with simple transitions (i.e. panning the map between annotations), this will allow users to construct narratives out of their annotations, which is something that many requests have been aimed at.</li>
<li>Integrate annotation feature into the MapKnitter. This will include:
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Integrating annotation functionality into MapKnitter UI. This will include usability testing.
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Integrating annotations into MapKnitter database so that they can be saved along with user-created maps.</li>
<li><p>Improve the narrative potential of maps by allowing users to attach an audio clip (either an upload from their computer or a link to SoundCloud) to a map, and then to link points in the audio to annotations on the map.</p>
<h4 id="stretch-goals">Stretch goals</h4>
<p>I will attempt to implement these if I finish the previous primary goals early.</p>
</li>
<li><p>Add rich media annotations, including attaching YouTube videos, audio from SoundCloud, photos, and file attachments. The variety of file types that it would be feasible to support would depend on the existing structure of the database.</p>
</li>
<li><p>Link commenting into the annotation system so that users can comment on each annotation.</p>
<h4 id="tools">Tools</h4>
<p>It makes sense to use HTML &lt;canvas&gt; elements because these, along with several Javascript libraries, already support many of the annotation functionalities that we are looking for (albeit in a non-geographic context). <a href="http://fabricjs.com/">Fabric.js</a>, <a href="http://www.createjs.com/#!/EaselJS">EaselJS</a>, and <a href="http://paperjs.org/">Paper.js</a> are a few of the most popular. I chose to go with Fabric.js (although I&#39;m open to other suggestions) because it is well-documented and seemed to have the best support for the kind of interactivity that we are looking for.</p>
<p><a href="https://github.com/CartoDB/Leaflet.CanvasLayer">Leaflet.CanvasLayer</a> is a plugin from CartoDB which extends Leaflet&#39;s native L.TileLayer.Canvas functionality by providing a canvas covering the entire map, rather than an individual canvas for each tile. I would use this as the canvas for Fabric.js. </p>
<h4 id="timeline-milestones">Timeline/Milestones</h4>
<p>The University of Chicago, along with a few other U.S. schools - i.e. Stanford, Northwestern, Dartmouth - is on a quarter system, which means I&#39;m not done with school until June 14, 2014. This means that I would need to start my project a bit later than other GSoC participants. However, if permitted, I could work until mid-September, since my fall quarter would not begin until September 29, 2014. The timeline below is scheduled according to that ideal setup.</p>
<p><strong>May 19 - June 23 (pre-summer period)</strong>
Read Fabric.js, Leaflet.js and Mapknitter documentation. Get to know my mentors and the community members most invested in this project.</p>
<p><strong>June 23</strong>
Begin coding Leaflet.js plugin.</p>
<p><strong>July 4 (End of Week 2)</strong>
Complete Leaflet.js plugin, with key methods <code>Leaflet.Annotate.text()</code>, <code>Leaflet.Annotate.arrow()</code>, <code>Leaflet.Annotate.shape()</code> and <code>Leaflet.Annotate.narrative()</code> (essentially an array of text, arrow, or shape types).</p>
<p><strong>July 7 - July 11 (Week 3)</strong>
Develop plan for storing the annotations to the database. Could use <code>Fabric.Canvas.toSVG()</code> or <code>Fabric.Canvas.toObject()</code>, depending on whether JSON or SVG output is preferred. Either method will have to be extended to include the geographic data.</p>
<p><strong>July 7 - August 8 (Week 3 - Week 7)</strong> 
Integrate Leaflet.js plugin with MapKnitter. Integrate with MapKnitter UI and database system.</p>
<p><strong>August 8 - August 25</strong>
Add narrative functionality/Soundcloud integration.</p>
<p><strong>August 25 - September 5</strong>
Run usability testing/focus group with ~20 volunteer MapKnitter community members in order to ensure that the annotation UI is intuitive and useful. Modify UI based on feedback.</p>
<p><strong>September 5 - September 12</strong>
Continue to develop and modify UI based on feedback from usability testing.</p>
<p><strong>Up to September 22</strong>
Complete tests and write up documentation for added features.</p>
<p><strong>September 22</strong>
Wrap up completed project. Revel in the awesome power of the new features!</p>
<p>Ultimately, the goal of this project is to make people at the grassroots level better able to communicate their concerns and their stories using MapKnitter.</p>
<h4 id="support">Support</h4>
<p>I will especially need the support and cooperation of the MapKnitter community when conducting usability testing, as I will depend on people being willing to volunteer some of their time to experiment with the beta UI and give constructive feedback.</p>
<h4 id="about-me">About me</h4>
<p><strong>Experience:</strong></p>
<p>I recently completed a major project building a <a href="https://github.com/manleyjster/dowsing-js">Javascript framework for administering geographic/spatial surveys</a> using the Google Maps API. Some details:
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Approx. 3000 lines of code (mostly in <a href="https://github.com/manleyjster/dowsing-js/blob/master/core.js">core.js</a>.
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Few dependencies, not even jQuery
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Meant to provide a complete framework for users so that users need only input static HTML content, not write Javascript </p>
<p>I also built a <a href="">survey application for The University of Chicago</a> using this framework, which we rolled out to 5000 undergraduates.
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html From this project, as well as developing the framework, I have experience working with a large maps API and with addressing the UI challenges peculiar to maps.</p>
<p>I have approx. 1 year of experience coding with Javascript and 3 years of experience with Python, Haskell, and PHP. Check out some of my other projects on Github at <a href="https://github.com/manleyjster?tab=repositories">https://github.com/manleyjster</a>.</p>
<p><strong>Interest</strong></p>
<p>I am interested in architecture and the built environment, and my interest in mapping comes out of this. Maps of all sorts are critical tools for architects as well as for planners making decisions that will shape the future of cities. Maps are also key instruments that citizens can use against architects and planners to demonstrate when proposed projects are destructive or otherwise problematic. The survey framework I developed at The University of Chicago (described above) is an example of this interest in action. It was used by the University of Chicago planning department to guide campus planning decisions.</p>
<p>I am also interested in UI/UX design, and I explored this as well with the survey framework I developed.</p>
<p><strong>Audience</strong></p>
<p>This feature is intended to make it easy for lay-users to create rich maps that will present a complete narrative.</p>
<p><strong>Context</strong></p>
<p>I&#39;m very interested in UI/UX design and in the open maps/map technology community. I&#39;m interested in working in the map technology community after I graduate, so this project relates strongly to my personal interests as well as my long-term career goals.</p>
<p><strong>Commitment</strong></p>
<p>I have no other commitment this summer, and would be able to work 40 hours/week on this project. As I mentioned above, The University of Chicago is on a quarter system, which means that I am done with school on June 14, 2014 and begin again on September 29, 2014. Ideally, I would be able to start GSoC late and end late to accommodate my schoolwork and final exams. I would work for the same amount of time as all other GSoC participants, but on a slightly different schedule. I am currently checking with the GSoC organizers to see if this would work.</p>
<p>If this is not an option, then I am willing to take three classes (instead of my normal four) this quarter, which would allow me to commit more time to this project while in school and complete it according to the standard GSoC timeline. </p>
<p>I am happy to have a conversation about the GSoC schedule/timeline and how my academic schedule relates to this if you have any questions!</p>
<h4 id="what-i-ve-done-so-far">What I&#39;ve done so far</h4>
<p>So far, I&#39;ve mocked up a page combining Fabric.js with Leaflet.js, using Leaflet.CanvasLayer as the canvas for Fabric.js. The <a href="https://github.com/manleyjster/cartannotate">code is on Github</a>.</p>
<p>As it stands, this code has a bunch of problems (obviously, since it&#39;s just smashing these two libraries together), the most serious of which are:</p>
<p>Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html Both the canvas and the map are trying to respond to <code>click</code> and <code>mousemove</code> events. This leads to erratic behavior from canvas elements. In order to solve this, I will most likely need to establish UI conventions for when a <code>click</code> is supposed to interact with the map, and when it is supposed to interact with the canvas.
Gemfile Gemfile.lock Gruntfile.js assets bower.json bugle.json bundler_gems data node_modules output package.json scripts simple simple.html site src templates transformed transformed.html The canvas element is not linked to a geographic location on the map, it is located to a point within the browser window.</p>
<p>My first steps working on the Leaflet plugin for GSoC will be to approach these problems.</p>
<h4 id="resources">Resources</h4>
<p>Some resources, both on Public Labs, and outside of it, that I have found useful in researching this project.</p>
<p><a href="https://github.com/jywarren/plots/issues/131#issuecomment-5990177">https://github.com/jywarren/plots/issues/131#issuecomment-5990177</a>
<a href="https://github.com/jywarren/mapknitter/issues/89">https://github.com/jywarren/mapknitter/issues/89</a>
<a href="https://github.com/makinacorpus/Leaflet.TextPath">https://github.com/makinacorpus/Leaflet.TextPath</a> 
<a href="https://www.mapbox.com/osmdev/2012/11/20/getting-serious-about-svg/">https://www.mapbox.com/osmdev/2012/11/20/getting-serious-about-svg/</a>
<a href="http://www.axismaps.com/blog/2012/07/the-why-not-the-best-map-thematic-mapping-with-leaflet/">http://www.axismaps.com/blog/2012/07/the-why-not-the-best-map-thematic-mapping-with-leaflet/</a>
<a href="http://giscollective.org/slippy-map-projections-explained/">http://giscollective.org/slippy-map-projections-explained/</a>
<a href="https://github.com/Leaflet/Leaflet.label">https://github.com/Leaflet/Leaflet.label</a></p>
<p><a href="http://publiclab.org/notes/mathew/03-14-2014/mapknitter-annotations-gsoc">http://publiclab.org/notes/mathew/03-14-2014/mapknitter-annotations-gsoc</a>
<a href="http://publiclab.org/notes/hagitkeysar/11-18-2013/where-do-the-maps-go">http://publiclab.org/notes/hagitkeysar/11-18-2013/where-do-the-maps-go</a>
<a href="http://publiclab.org/notes/shannon/1-9-2013/map-annotation-brainstorming-notes">http://publiclab.org/notes/shannon/1-9-2013/map-annotation-brainstorming-notes</a>
<a href="http://publiclab.org/notes/warren/5-15-2012/annotated-maps-roundup">http://publiclab.org/notes/warren/5-15-2012/annotated-maps-roundup</a>
<a href="https://github.com/jywarren/mapknitter/blob/master/app/controllers/annotation_controller.rb">https://github.com/jywarren/mapknitter/blob/master/app/controllers/annotation_controller.rb</a></p>
</li>
</ol>
</div></div>
